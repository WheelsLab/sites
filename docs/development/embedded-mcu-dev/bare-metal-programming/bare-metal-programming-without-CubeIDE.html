<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-development/embedded-mcu-dev/bare-metal-programming/bare-metal-programming-without-CubeIDE" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">从 Bare Metal 到 CubeIDE | WheelsLab</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://WheelsLab.github.io/sites/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://WheelsLab.github.io/sites/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://WheelsLab.github.io/sites/docs/development/embedded-mcu-dev/bare-metal-programming/bare-metal-programming-without-CubeIDE"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="从 Bare Metal 到 CubeIDE | WheelsLab"><meta data-rh="true" name="description" content="本教程是一份 STM32 裸机编程实践指南。内容聚焦于在不依赖任何现成库的前提下，探索“真正的”裸机开发流程：从最小可运行系统出发，逐步引入必要的抽象与工具，最终过渡到完整的 IDE 与官方生态。"><meta data-rh="true" property="og:description" content="本教程是一份 STM32 裸机编程实践指南。内容聚焦于在不依赖任何现成库的前提下，探索“真正的”裸机开发流程：从最小可运行系统出发，逐步引入必要的抽象与工具，最终过渡到完整的 IDE 与官方生态。"><link data-rh="true" rel="icon" href="/sites/img/favicon.png"><link data-rh="true" rel="canonical" href="https://WheelsLab.github.io/sites/docs/development/embedded-mcu-dev/bare-metal-programming/bare-metal-programming-without-CubeIDE"><link data-rh="true" rel="alternate" href="https://WheelsLab.github.io/sites/docs/development/embedded-mcu-dev/bare-metal-programming/bare-metal-programming-without-CubeIDE" hreflang="en"><link data-rh="true" rel="alternate" href="https://WheelsLab.github.io/sites/docs/development/embedded-mcu-dev/bare-metal-programming/bare-metal-programming-without-CubeIDE" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"嵌入式软件开发","item":"https://WheelsLab.github.io/sites/docs/development/embedded-mcu-dev/"},{"@type":"ListItem","position":2,"name":"裸机编程","item":"https://WheelsLab.github.io/sites/docs/development/embedded-mcu-dev/bare-metal-programming/"},{"@type":"ListItem","position":3,"name":"从 Bare Metal 到 CubeIDE","item":"https://WheelsLab.github.io/sites/docs/development/embedded-mcu-dev/bare-metal-programming/bare-metal-programming-without-CubeIDE"}]}</script><link rel="alternate" type="application/rss+xml" href="/sites/blog/rss.xml" title="WheelsLab RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/sites/blog/atom.xml" title="WheelsLab Atom Feed">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.css" integrity="sha384-m7LqaUc4JRc2uA7D4zSVUs/sgkYhmOOe9+Gd8DFmmAXH8vzs15fmw05YXvpxsoQB" crossorigin="anonymous"><link rel="stylesheet" href="/sites/assets/css/styles.54e22259.css">
<script src="/sites/assets/js/runtime~main.a7f612d2.js" defer="defer"></script>
<script src="/sites/assets/js/main.4d285f79.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/sites/img/favicon.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/sites/"><div class="navbar__logo"><img src="/sites/img/favicon.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/sites/img/favicon.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">WheelsLab</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">知识库</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/sites/docs/cs-complete/Automata-Theory">CS 补完计划</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/sites/docs/development/embedded-mcu-dev">软件开发</a></li><li><a class="dropdown__link" href="/sites/docs/linux-playground">Linux 折腾笔记</a></li><li><a class="dropdown__link" href="/sites/docs/scientific-networking">科学上网</a></li><li><a class="dropdown__link" href="/sites/docs/miscellaneous">杂项</a></li><li><a class="dropdown__link" href="/sites/about-this-site">关于本站</a></li></ul></div><a class="navbar__item navbar__link" href="/sites/blog">博客</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/WheelsLab/doc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/sites/"><img src="/sites/img/favicon.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/sites/img/favicon.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b>WheelsLab</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/sites/docs/development/embedded-mcu-dev"><span title="嵌入式软件开发" class="categoryLinkLabel_W154">嵌入式软件开发</span></a><button aria-label="Collapse sidebar category &#x27;嵌入式软件开发&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/sites/docs/development/embedded-mcu-dev/bare-metal-programming"><span title="裸机编程" class="categoryLinkLabel_W154">裸机编程</span></a><button aria-label="Collapse sidebar category &#x27;裸机编程&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/sites/docs/development/embedded-mcu-dev/bare-metal-programming/bare-metal-programming-without-CubeIDE"><span title="从 Bare Metal 到 CubeIDE" class="linkLabel_WmDU">从 Bare Metal 到 CubeIDE</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/sites/docs/development/embedded-mcu-dev/stm32-dev-basic"><span title="STM32 基础" class="categoryLinkLabel_W154">STM32 基础</span></a><button aria-label="Expand sidebar category &#x27;STM32 基础&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/sites/docs/development/embedded-mcu-dev/stm32-project-blance-car"><span title="STM32 平衡车" class="categoryLinkLabel_W154">STM32 平衡车</span></a><button aria-label="Expand sidebar category &#x27;STM32 平衡车&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/sites/docs/development/learn-react"><span title="React" class="linkLabel_WmDU">React</span></a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/sites/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/sites/docs/development/embedded-mcu-dev"><span>嵌入式软件开发</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/sites/docs/development/embedded-mcu-dev/bare-metal-programming"><span>裸机编程</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">从 Bare Metal 到 CubeIDE</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>从 Bare Metal 到 CubeIDE</h1></header>
<p>本教程是一份 <strong>STM32 裸机编程实践指南</strong>。内容聚焦于在<strong>不依赖任何现成库</strong>的前提下，探索“真正的”裸机开发流程：从最小可运行系统出发，逐步引入必要的抽象与工具，最终过渡到完整的 IDE 与官方生态。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>什么是裸机编程？</p><p>简单来说，裸机编程（Bare Metal Programming）就是<strong>直接运行在 CPU 上的程序</strong>：</p><ul>
<li class="">不依赖操作系统</li>
<li class="">不依赖厂商提供的高层库（例如 STM32 HAL）</li>
<li class="">需要直接操作硬件寄存器</li>
</ul><p>在这种模式下，最重要的参考资料不再是 API 文档，而是 <strong>CPU 架构手册</strong> 和 <strong>MCU 的 Reference Manual</strong> ——其中详细描述了寄存器布局、位定义以及外设工作方式。</p><p>可以看下这个 reddit 讨论：<a href="https://www.reddit.com/r/embedded/comments/10o0udj/what_is_bare_metal_programming_and_how_to_get/" target="_blank" rel="noopener noreferrer" class="">https://www.reddit.com/r/embedded/comments/10o0udj/what_is_bare_metal_programming_and_how_to_get/</a></p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>声明</div><div class="admonitionContent_BuS1"><p>本系列主要参考了 <a href="https://kleinembedded.com/" target="_blank" rel="noopener noreferrer" class="">Klein Embedded</a> 的系列博客，原文基于 <code>STM32F410RB</code>，本文在结构和思路保持一致的前提下，针对 <code>STM32F103C8T6</code> 做了适当调整和改写。</p><p><img decoding="async" loading="lazy" alt="Blue Pill: Perspective view" src="/sites/assets/images/STM32F103C8T6_Blue_Pill-1-0f1e7c48eb045b0123728f1375c4af43.jpg" width="1920" height="1280" class="img_ev3q"></p><p>主要参考链接如下：</p><ul>
<li class=""><a href="https://kleinembedded.com/" target="_blank" rel="noopener noreferrer" class="">Klein Embedded</a>：<!-- -->
<ul>
<li class="">
<p><a href="https://kleinembedded.com/stm32-without-cubeide-part-1-the-bare-necessities/" target="_blank" rel="noopener noreferrer" class="">STM32 without CubeIDE (Part 1): The bare necessities</a></p>
</li>
<li class="">
<p><a href="https://kleinembedded.com/stm32-without-cubeide-part-2-cmsis-make-and-clock-configuration/" target="_blank" rel="noopener noreferrer" class="">STM32 without CubeIDE (Part 2): CMSIS, make and clock configuration</a></p>
</li>
<li class="">
<p><a href="https://kleinembedded.com/stm32-without-cubeide-part-3-the-c-standard-library-and-printf/" target="_blank" rel="noopener noreferrer" class="">STM32 without CubeIDE (Part 3): The C Standard Library and printf()</a></p>
</li>
<li class="">
<p><a href="https://kleinembedded.com/stm32-without-cubeide-part-4-cmake-fpu-and-stm32-libraries/" target="_blank" rel="noopener noreferrer" class="">STM32 without CubeIDE (Part 4): CMake, FPU and STM32 libraries</a></p>
</li>
</ul>
</li>
</ul><p>此外，<strong>cpq</strong> 的裸机编程指南同样是非常重要的参考资料：</p><ul>
<li class="">GitHub@<strong>cpq</strong>：<a href="https://github.com/cpq/bare-metal-programming-guide/blob/main/README_zh-CN.md" target="_blank" rel="noopener noreferrer" class="">裸机编程指南</a></li>
</ul><p>本文对应的完整示例代码已整理并发布在我的 GitHub 仓库中：<a href="https://github.com/WheelsLab/bare-metal-programming-without-CubeIDE.git" target="_blank" rel="noopener noreferrer" class="">https://github.com/WheelsLab/bare-metal-programming-without-CubeIDE.git</a></p></div></div>
<p>整个系列将分为四个部分，循序渐进地构建完整的 STM32 开发环境：</p>
<ul>
<li class="">
<p>第 1 部分</p>
<p>编写链接脚本与启动代码（startup code），构建最小可运行程序，并完成一个最基础的 LED 闪烁示例。</p>
</li>
<li class="">
<p>第 2 部分</p>
<p>引入 <strong>CMSIS</strong>，使用 <code>Make</code> 实现构建自动化；通过<strong>寄存器级配置</strong>完成系统时钟设置，并使用 <strong>SysTick 定时器</strong>验证时钟是否工作正常。</p>
</li>
<li class="">
<p>第 3 部分</p>
<p>引入 <strong>C 标准库（newlib）</strong>，实现 <code>printf</code> 等基础调试手段，理解嵌入式环境中标准库的裁剪与取舍。</p>
</li>
<li class="">
<p>第 4 部分</p>
<p>引入 <strong>HAL / LL 库</strong>，并使用 <strong>CMake</strong> 作为元构建系统，完成从“纯裸机”到现代嵌入式工程结构的过渡。</p>
</li>
</ul>
<p>任何编程开发工作都离不开工具链，其职责是将人类可读的源代码转换为处理器能够执行的指令。</p>
<p>在嵌入式开发中，由于目标处理器架构（如 ARM Cortex-M）与本机架构不同，因此需要使用 <strong><a href="https://zh.wikipedia.org/wiki/%E4%BA%A4%E5%8F%89%E7%B7%A8%E8%AD%AF%E5%99%A8" target="_blank" rel="noopener noreferrer" class="">交叉编译工具链</a></strong> 。本教程使用的是官方维护的 <strong><a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads" target="_blank" rel="noopener noreferrer" class="">GNU Arm Toolchain</a></strong>，用于生成 Cortex-M 可执行代码。</p>
<p>在 <strong>Arch Linux</strong> 环境下，可通过以下方式安装所需工具：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ paru -S arm-none-eabi-gcc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         arm-none-eabi-binutils \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         arm-none-eabi-gdb \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         arm-none-eabi-newlib \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         openocd \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         cmake</span><br></span></code></pre></div></div>
<ul>
<li class="">GNU ARM Toolchain 包含以下内容<!-- -->
<ul>
<li class="">
<p><strong><code>arm-none-eabi-gcc</code></strong>：负责编译与链接</p>
<ul>
<li class=""><code>gcc</code>：将 C/C++ 代码编译为目标架构的机器码</li>
<li class=""><code>as</code>：汇编器，生成目标文件（<code>.o</code>）</li>
<li class=""><code>ld</code>：链接器，根据链接脚本生成最终可执行文件（<code>.elf</code>）</li>
</ul>
</li>
<li class="">
<p><strong><code>arm-none-eabi-binutils</code></strong>：二进制工具集</p>
<ul>
<li class="">
<p><code>size</code>：查看 Flash / RAM 占用</p>
</li>
<li class="">
<p><code>objcopy</code>：生成 <code>.bin</code> / <code>.hex</code> 文件</p>
</li>
<li class="">
<p><code>objdump</code>：反汇编与静态分析</p>
</li>
</ul>
</li>
<li class="">
<p><strong><code>arm-none-eabi-gdb</code></strong>：调试器，用于在硬件或仿真环境中调试程序，检查寄存器与内存状态。</p>
</li>
<li class="">
<p><strong><code>arm-none-eabi-newlib</code></strong>：嵌入式 C 标准库，是 <code>glibc</code> 在嵌入式场景下的轻量级替代方案。</p>
</li>
</ul>
</li>
</ul>
<p>除了编译工具链外，还需要：</p>
<ul>
<li class=""><strong><code>cmake</code></strong>：元构建系统，用于生成平台相关的构建文件</li>
<li class=""><strong><code>make</code></strong>：实际执行构建任务的工具</li>
<li class=""><strong><code>openocd</code></strong>：烧录与调试接口</li>
</ul>
<p>在 Arch Linux 上，<code>make</code> 包含在 <code>base-devel</code> 包组中（如果你已经使用 <a href="https://wiki.archlinux.org/title/Arch_User_Repository" target="_blank" rel="noopener noreferrer" class="">AUR</a>)，通常已安装）：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># pacman -S base-devel</span><br></span></code></pre></div></div>
<p>最后，还需要一个代码编辑器。本文示例使用 <strong><a href="https://wiki.archlinux.org/title/Visual_Studio_Code" target="_blank" rel="noopener noreferrer" class="">VS Code</a></strong>，当然你也可以选择 <strong><a href="https://wiki.archlinuxcn.org/wiki/Vim" target="_blank" rel="noopener noreferrer" class="">Vim</a></strong> 或其他熟悉的编辑环境。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ paru -S visual-studio-code-bin</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="第-1-部分裸机编程之最小闪灯程序">第 1 部分：裸机编程之最小闪灯程序<a href="#第-1-部分裸机编程之最小闪灯程序" class="hash-link" aria-label="Direct link to 第 1 部分：裸机编程之最小闪灯程序" title="Direct link to 第 1 部分：裸机编程之最小闪灯程序" translate="no">​</a></h2>
<p>本节我们将深入底层，通过<strong>手写链接脚本</strong>、<strong>定制启动代码</strong>来实现一个最基础的闪灯程序。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="构建流程">构建流程<a href="#构建流程" class="hash-link" aria-label="Direct link to 构建流程" title="Direct link to 构建流程" translate="no">​</a></h3>
<p>我们从最精简的工程起步。目标很简单：不依赖任何第三方库，在完全透明的状态下点亮一颗 LED</p>
<p><img decoding="async" loading="lazy" alt="Build Process Simple" src="/sites/assets/images/build_process_simple.drawio-420e6283554579d00740a26a84d8db98.png" width="1522" height="562" class="img_ev3q"></p>
<p>整个过程通常分为以下阶段：</p>
<ol>
<li class=""><strong>编译与链接：</strong> 源代码由编译器（Compiler）转换为中间目标文件，再由链接器（Linker）合并为可执行文件。</li>
<li class=""><strong>烧录：</strong> 利用编程器（Programmer）将成品固件写入微控制器的 Flash。</li>
<li class=""><strong>执行：</strong> MCU 上电复位，运行代码。</li>
</ol>
<p>下面，来看下一个更具体的例子，以了解更多细节。</p>
<p>我们有以下文件：</p>
<ul>
<li class=""><strong>链接脚本 (<code>linker_script.ld</code>)</strong>：定义内存布局。</li>
<li class=""><strong>启动代码 (<code>startup.c</code>)</strong>：处理复位向量与环境初始化。</li>
<li class=""><strong>应用程序 (<code>main.c</code>)</strong>：逻辑入口。</li>
</ul>
<p>在执行 <code>arm-none-eabi-gcc</code> 时，编译器会将各个 <code>.c</code> 文件编译成独立的目标文件 <code>.o</code>。紧接着，链接器 <code>arm-none-eabi-ld</code> 会介入，<strong>链接脚本</strong>在此扮演“地图”的角色，指引链接器将代码段（.text）和数据段（.data）准确地安置在微控制器内存的指定位置，最终产出 <code>blink.elf</code>。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>实际使用时，一般只调用 <code>gcc</code>，而不会手动区分“编译”和“链接”。如果需要中间产物，可以通过参数控制，比如<code>-c</code> 可以输出目标文件，而不进行链接，<code>-Wl,-Map=filename.map</code> 可以输出内存映射文件。</p><p>感兴趣的话可以翻一下 GCC 的文档：<a href="https://gcc.gnu.org/onlinedocs/gcc/Overall-Options.html#Overall-Options" target="_blank" rel="noopener noreferrer" class="">https://gcc.gnu.org/onlinedocs/gcc/Overall-Options.html#Overall-Options</a></p></div></div>
<p><img decoding="async" loading="lazy" alt="build process detail" src="/sites/assets/images/build_process.drawio-2-e830e89404cef04b3a5f571e334f3158.png" width="1522" height="1522" class="img_ev3q"></p>
<p>编译完成后，PC 通过 <strong>OpenOCD</strong> 驱动 <strong>ST-Link</strong>，将二进制数据写入 Flash。 当 MCU 启动时，硬件首先执行启动代码。首先将确保初始化数据段（<code>.data</code>）复制到 SRAM，未初始化数据段（<code>.bss</code>）填充为零，然后再调用 <code>main()</code> 函数，即我们的程序。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>ELF 是烧录到 MCU flash 中的程序，但 <code>ELF</code> 是什么？前面提到的 <code>blink.elf</code> 并不是“纯代码”，而是一个带结构的文件。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format" target="_blank" rel="noopener noreferrer" class="">ELF（Executable and Linkable Format）</a>，是 UNIX &amp;   Linux 系统中可执行文件、目标文件和共享库的格式。换句话说，编译后的程序（可执行二进制文件）除了真正的指令和数据，还有一些元数据，这些元数据是操作系统加载程序到内存时运行所需的。ELF 文件，分为两个部分，头部（ELF Header）和多个节（Section）。<a href="https://en.wikipedia.org/wiki/GNU_Binutils" target="_blank" rel="noopener noreferrer" class="">GNU binutils</a> 包括 <code>objdump</code>、<code>nm</code>、<code>readelf</code> 都可以检视 ELF 文件的内容。节（Section）存放代码和数据，典型的节包括 <code>.text</code>、<code>.data</code>、<code>.rodata</code></summary><div><div class="collapsibleContent_i85q"><p><img decoding="async" loading="lazy" alt="img" src="/sites/assets/images/ELF-structure-simplified-c7ed255fd3c9d693aa93916ac07e6089.png" width="800" height="886" class="img_ev3q"></p><p>这篇 Wiki 很好的解释了 ELF：<a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format" target="_blank" rel="noopener noreferrer" class="">https://en.wikipedia.org/wiki/Executable_and_Linkable_Format</a></p><p><img decoding="async" loading="lazy" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/ELF_Executable_and_Linkable_Format_diagram_by_Ange_Albertini.png/500px-ELF_Executable_and_Linkable_Format_diagram_by_Ange_Albertini.png" alt="img" class="img_ev3q"></p><p>想深入的话，可以看看 Wiki：</p><ul>
<li class=""><a href="https://linux-audit.com/elf-binaries-on-linux-understanding-and-analysis/#structure" target="_blank" rel="noopener noreferrer" class="">https://linux-audit.com/elf-binaries-on-linux-understanding-and-analysis/#structure</a></li>
<li class=""><a href="https://intezer.com/blog/executable-and-linkable-format-101-part-1-sections-and-segments/" target="_blank" rel="noopener noreferrer" class="">https://intezer.com/blog/executable-and-linkable-format-101-part-1-sections-and-segments/</a></li>
</ul><p>还有一些有意思的讨论：</p><p>reddit 讨论，</p><ul>
<li class="">
<p>向不懂技术的人解释 ELF：<a href="https://www.reddit.com/r/linuxquestions/comments/17rhr8v/how_would_you_explain_the_linux_elf_format_to_a/" target="_blank" rel="noopener noreferrer" class="">https://www.reddit.com/r/linuxquestions/comments/17rhr8v/how_would_you_explain_the_linux_elf_format_to_a/</a></p>
</li>
<li class="">
<p>ELF 和 BIN 有区别吗？<a href="https://stackoverflow.com/questions/2427011/what-is-the-difference-between-elf-files-and-bin-files" target="_blank" rel="noopener noreferrer" class="">https://stackoverflow.com/questions/2427011/what-is-the-difference-between-elf-files-and-bin-files</a></p>
</li>
</ul><p>速查资料：</p><ul>
<li class="">elf_format_cheatsheet：<a href="https://gist.github.com/x0nu11byt3/bcb35c3de461e5fb66173071a2379779" target="_blank" rel="noopener noreferrer" class="">https://gist.github.com/x0nu11byt3/bcb35c3de461e5fb66173071a2379779</a></li>
</ul></div></div></details></div></div>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="链接脚本如何安排代码在内存中的位置">链接脚本——如何安排代码在内存中的位置<a href="#链接脚本如何安排代码在内存中的位置" class="hash-link" aria-label="Direct link to 链接脚本——如何安排代码在内存中的位置" title="Direct link to 链接脚本——如何安排代码在内存中的位置" translate="no">​</a></h3>
<p>链接脚本的工作，可以理解为<strong>给链接器一份内存分布说明</strong>，主要解决三件事：</p>
<ol>
<li class="">处理器启动后，程序从哪里开始执行（也就是入口点）。</li>
<li class="">MCU 内部有哪些可用的存储区（memory region）。</li>
<li class="">不同类型的代码和数据，应该放在内存的什么位置。</li>
</ol>
<p>链接脚本使用的是链接器自己的命令语言，完整语法可以在 GNU ld 的文档中找到：<a href="https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_chapter/ld_3.html" target="_blank" rel="noopener noreferrer" class="">这里</a>。</p>
<p>不过这里用到的内容并不多，理解几个常用指令就足够了。</p>
<p>首先是程序入口点，通过 <code>ENTRY()</code> 命令指定。启动代码中会实现一个名为 <code>reset_handler()</code> 的函数，用来完成最早期的初始化工作，比如内存拷贝和清零。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">linker_script.ld</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">ENTRY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reset_handler</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>接下来需要弄清楚 MCU 的内存长什么样。Flash 和 SRAM 的大小因型号而异，这些信息需要直接查 <strong>数据手册（Datasheet）</strong>。以 <code>STM32F103C8T6</code> 为例，相关参数可以在官方文档中找到：<a href="https://www.st.com/en/microcontrollers-microprocessors/stm32f103/documentation.html" target="_blank" rel="noopener noreferrer" class="">数据手册 DS5319</a></p>
<p>后续链接脚本的内容，本质上就是把这些“硬件规格”翻译成链接器能理解的描述，让代码和数据各就各位。</p>
<p><img decoding="async" loading="lazy" alt="specification intro" src="/sites/assets/images/DS5319-hardware-specification-intro-a6d7dec8c853d686f285714f4965a09b.png" width="955" height="613" class="img_ev3q"></p>
<p><code>STM32F103C8T6</code> 中的 <strong>C8</strong>，按照 ST 的命名规则，对应 <strong>64 KB 的 Flash</strong>；此外从图中可以看到 SRAM 是 20 Kb</p>
<p>继续往数据手册后面翻，在 <strong>第 4 节 Memory Mapping</strong> 中，可以找到更关键的地址信息：</p>
<ul>
<li class=""><strong>SRAM 起始地址</strong>：<code>0x2000 0000</code></li>
<li class=""><strong>Flash 起始地址</strong>：<code>0x0800 0000</code></li>
</ul>
<p><img decoding="async" loading="lazy" alt="memory map" src="/sites/assets/images/DS5319-memory-map-fc0bf8f2d80f331f214d0660cd7e4916.png" width="678" height="742" class="img_ev3q"></p>
<p>到这里，定义内存区域所需的信息就齐全了。接下来就可以在链接脚本中，用 <code>MEMORY</code> 命令把这些信息明确写出来：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MEMORY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">FLASH</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ORIGIN </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x08000000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> LENGTH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain">K</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">SRAM</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rwx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ORIGIN </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20000000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> LENGTH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">K</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>接下来要解决的问题是：<strong>目标文件里的各个段，具体该放进这些内存区域的什么位置？</strong></p>
<p>先回忆一下前面提到过的内存示意图：</p>
<p><img decoding="async" loading="lazy" alt="flash sram" src="/sites/assets/images/flash_sram_memory-977f3629c3914bc1ccfa781bda853b17.png" width="1142" height="896" class="img_ev3q"></p>
<p>Flash 中第一部分是最前面是 <strong>中断向量表</strong>（ISR, Interrupt Service Routine) <code>.isr_vector</code>，默认位于地址 <code>0x0000 0000</code>（实际上会映射到 Flash 起始位置）。然后是 <code>.text</code> 段，也就是程序指令。然后是 <code>.rodata</code>，存放只读数据。最后是 <code>.data</code> 其中包含是<strong>有初始值的全局变量</strong>，这些数据在启动时会从 Flash 复制到 SRAM 中。而在 SRAM 中，还会有一个 <code>.bss</code> 段，用来存放<strong>未初始化的全局变量</strong>，启动时需要清零</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>如果想查看某个 <code>.elf</code> 或 <code>.o</code> 文件里具体包含哪些段，可以使用：<code>arm-none-eabi-objdump -h &lt;filename&gt;</code></p></div></div>
<p>有了这些背景，就可以使用 <code>SECTIONS</code> 命令来正式定义各个段的布局了：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">linker_script.ld</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SECTIONS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isr_vector </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">KEEP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isr_vector</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">FLASH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rodata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _etext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">FLASH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _sdata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _edata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">SRAM AT</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> FLASH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bss </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _sbss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bss</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _ebss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">SRAM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>这里有几个关键点值得注意。首先，每个 <code>SECTION</code> 后面都会跟一个内存区域说明，比如 <code>&gt;FLASH</code> 或 <code>&gt;SRAM</code>，用来指定这个段最终放在哪一块内存中。</p>
<p>其中比较特殊的是 <strong><code>.data</code> 段</strong>，它有两个内存地址</p>
<ul>
<li class="">
<p><code>&gt;SRAM</code>：<strong>运行时地址</strong>（VMA，程序执行时访问的地址）</p>
</li>
<li class="">
<p><code>AT&gt; FLASH</code>：<strong>加载地址</strong>（LMA，数据实际存放的位置）</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.data : { ... } &gt;SRAM AT&gt; FLASH</span><br></span></code></pre></div></div>
<p>原因也很直观，SRAM 是易失的，断电就没了，因此 <code>.data</code> 的初始值只能先存在 Flash 中；MCU 启动时，再由启动代码把这部分数据复制到 SRAM。</p>
<p>其他所有节都只有一个内存地址（<code>.text</code>、<code>.rodata</code> 只存在于 Flash、<code>.bss</code> 只存在于 SRAM），它们的加载地址和运行地址是同一个，因此不需要额外说明。</p>
<p>此外，在脚本中还定义了一些符号：<code>_etext</code>、<code>_sdata</code>、<code>_edata</code>、<code>_sbss</code> 和 <code>_ebss</code>，以及用到了位置计数器 <code>.</code>。稍后将在启动代码中使用这些符号，以确保复制（<code>.data</code>）和清零（<code>.bss</code>）正确的内存地址。</p>
<p>链接脚本到这里就告一段落了。</p>
<p>下一步，就是看看启动代码是如何利用这些符号，把 MCU 从“刚上电的状态”带到 <code>main()</code> 的。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="启动代码在执行-main-之前做好准备">启动代码——在执行 <code>main()</code> 之前做好准备<a href="#启动代码在执行-main-之前做好准备" class="hash-link" aria-label="Direct link to 启动代码在执行-main-之前做好准备" title="Direct link to 启动代码在执行-main-之前做好准备" translate="no">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>ARM Cortex-M 启动流程</div><div class="admonitionContent_BuS1"><p><a href="https://www.amazon.com/Definitive-Guide-Cortex%C2%AE-M3-Cortex%C2%AE-M4-Processors/dp/0124080820" target="_blank" rel="noopener noreferrer" class="">The Definitive Guide to ARM® Cortex®-M3 and Cortex®-M4 Processors 3rd Edition</a> 的 4.8 节 Reset and reset sequence 对启动流程有非常详细的说明。</p><p>基于 Cortex-M 的 MCU 通常具有三类重置（reset）：</p><ul>
<li class="">Power on reset——上电复位，处理器、调试组件、外设全部重置，相当于“彻底清空重来”。</li>
<li class="">System reset——重置处理器和外设，但调试组件仍然保持状态。</li>
<li class="">Processor reset——只重置处理器核心。</li>
</ul><p>上电后的第一步：<strong>向量表</strong></p><p>在真正开始执行代码之前，处理器会先去内存起始地址 <code>0x0000_0000</code> 读取两个 32 位的 word（<a href="https://stackoverflow.com/questions/5295903/how-many-bits-does-a-word-contain-in-32-64-bit-os-respectively" target="_blank" rel="noopener noreferrer" class="">word = 32 bit</a>）。这里存放的正是 <strong>中断向量表（vector table）</strong> 的前两个条目：</p><ul>
<li class="">
<p><strong>主<a href="https://en.wikipedia.org/wiki/Stack_register" target="_blank" rel="noopener noreferrer" class="">栈指针</a>（MSP, Main Stack Pointer）</strong></p>
</li>
<li class="">
<p><strong>Reset Vector（reset handler 的入口地址）</strong></p>
</li>
</ul><p>处理器会用这两个值初始化寄存器：MSP 写入 R13，Reset Vector 写入 PC（Program Counter），随后从 reset handler 开始执行。</p><p><img decoding="async" loading="lazy" alt="Cortex-M reset sequence" src="/sites/assets/images/cortex-m-reset-sequence-f6ba8cba7c267faf5271878b5254022e.png" width="1052" height="380" class="img_ev3q"></p><p>Cortex-M 使用的是<strong>全递减栈（full descending stack）</strong>，也就是说，<strong>先递减 SP，再写入数据</strong>。因此，SP 的初始值并不是栈的起始地址，而是<strong>栈区上方的第一个字节</strong>。比如，下图中，栈的内存从 <code>0x20007C00</code> 到 <code>0x20007FFF</code>（共 1 Kbytes），所以 SP 的初始值应当设置为 <code>0x20008000</code>（刚好是栈上方的第一个字节）。</p><p>还有一个容易忽略的小点，向量表中的函数地址，<strong>最低位（LSB）必须为 1</strong>，用于表示 Thumb 状态。比如，下图中的 reset vector 的值是 <code>0x101</code>，但是 reset handler（boot code）的起始地址实际上是 <code>0x100</code>。</p><p><img decoding="async" loading="lazy" alt="SP and PC initial value" src="/sites/assets/images/SP-and-PC-initial-value-52fc15d7468fa986175f0ab41a7f5a5d.png" width="1006" height="919" class="img_ev3q"></p><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>栈指针和栈并不是“抽象概念”，函数调用、局部变量分配，底层都依赖它。</p><ul>
<li class=""><a href="https://www.reddit.com/r/AskComputerScience/comments/13cf1y0/does_a_cpu_know_about_a_stack_and_a_heap_or_are/" target="_blank" rel="noopener noreferrer" class="">https://www.reddit.com/r/AskComputerScience/comments/13cf1y0/does_a_cpu_know_about_a_stack_and_a_heap_or_are/</a></li>
<li class=""><a href="https://www.quora.com/What-is-the-stack-in-a-CPU" target="_blank" rel="noopener noreferrer" class="">https://www.quora.com/What-is-the-stack-in-a-CPU</a></li>
</ul></div></div></div></div>
<p>在 <code>startup.c</code> 中，需要做以下事：</p>
<ul>
<li class="">初始化位于 <code>.isr_vector</code> 段的主栈指针（MSP, main stack pointer）和中断向量表（interrupt vector table）</li>
<li class="">将 <code>.data</code> 段从 Flash 拷贝到 SRAM</li>
<li class="">将 <code>.bss</code> 段清零</li>
</ul>
<p>主栈指针通常指向 SRAM 末尾的下一个字节。随着函数调用和局部变量压栈，SP 会不断向低地址移动。已知 SRAM 的起始地址和大小后，结束地址就很好算：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">startup.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">SRAM_START</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0x20000000U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">SRAM_SIZE</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">20U</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1024U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">SRAM_END</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">SRAM_START </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> SRAM_SIZE</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">STACK_POINTER_INIT_ADDRESS</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">SRAM_END</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>这个值会被放在向量表的第一个 word 中，上电后由处理器自动加载到 R13。</p>
<p>向量表（vector table）中除了主堆栈指针的值外，还需要 15 个字用于 Cortex-M 的系统异常（System Exception）处理程序。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>向量表本质上就是一个<strong>函数指针数组</strong>。</p></div></div>
<p>后续条目对应具体芯片的外设中断对于 <code>STM32F103C8T6</code>，一共是 68 个中断向量（见 RM0008）有些字是保留的，只需要填充 0 即可。</p>
<p><img decoding="async" loading="lazy" alt="NVIC vectors" src="/sites/assets/images/number-of-NVIC-vectors-1afba12ffa7b930d26066d76adb00ce2.png" width="944" height="296" class="img_ev3q"></p>
<p>RM0008 的 10.1.2 Interrupt and exception vectors 中列出了所有中断。这里只实现两个处理函数： <code>reset_handler()</code> 和 <code>default_handler()</code>。其他中断全部弱引用到 <code>default_handler()</code>，以后需要时再单独实现即可。请注意 <code>isr_vector[]</code> 的节属性，以确保位于正确的内存区域。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">startup.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdint.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">ISR_VECTOR_SIZE_WORDS</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">84</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// System Exception handlers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reset_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">default_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nmi_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">weak</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default_handler&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hard_fault_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">weak</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default_handler&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bus_fault_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">weak</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default_handler&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">usage_fault_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">weak</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default_handler&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">svcall_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">weak</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default_handler&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">debug_monitor_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">weak</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default_handler&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pendsv_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">weak</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default_handler&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">systick_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">weak</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default_handler&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// continue adding device interrupt handlers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">uint32_t</span><span class="token plain"> isr_vector</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ISR_VECTOR_SIZE_WORDS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">section</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;.isr_vector&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  STACK_POINTER_INIT_ADDRESS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">reset_handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nmi_handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hard_fault_handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">bus_fault_handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">usage_fault_handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">svcall_handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">debug_monitor_handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pendsv_handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">systick_handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// continue adding device interrupt handlers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">default_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>最后我们需要实现 <code>reset_handler()</code> 函数，已经在链接脚本中指定为程序入口。这部分，我们会使用链接脚本中的符号，将 <code>.data</code> 段（起始于 <code>_etext</code>）从 Flash 复制到 SRAM （起始于 <code>_sdata</code>），并且把充位于 SRAM 中的 <code>.bss</code> 段（从 <code>._sbss</code> 到 <code>_ebss</code>）清零。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">startup.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> _etext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _sdata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _edata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _sbss</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ebss</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reset_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Copy .data from FLASH to SRAM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">uint32_t</span><span class="token plain"> data_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_edata </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_sdata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">flash_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_etext</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sram_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_sdata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> data_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sram_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flash_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Zero-fill .bss section in SRAM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">uint32_t</span><span class="token plain"> bss_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_ebss </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_sbss</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">bss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_sbss</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> bss_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bss</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>到这里，运行环境已经准备就绪，程序终于正式进入熟悉的 <code>main()</code>。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="最小闪灯程序">最小闪灯程序<a href="#最小闪灯程序" class="hash-link" aria-label="Direct link to 最小闪灯程序" title="Direct link to 最小闪灯程序" translate="no">​</a></h3>
<p>在嵌入式世界里，<code>main()</code> 里的 “Hello World” 通常不是打印字符串，而是——<strong>点亮一颗 LED</strong>。</p>
<p>我的开发版上有一个蓝色 LED，正极接 VCC，负极接到 <code>PC13</code>，采用的是<strong>开漏（open-drain）接法</strong>。</p>
<p><img decoding="async" loading="lazy" alt="on-board LED" src="/sites/assets/images/PC13-on-board-LED-8a4449f6e6a95e9289830a5188c8a94b.png" width="584" height="156" class="img_ev3q"></p>
<p>想让这颗 LED 闪起来，需要做的事情并不复杂：</p>
<ul>
<li class="">打开 GPIOC 端口的外设时钟</li>
<li class="">把 PC13 配置成<strong>开漏输出模式</strong></li>
<li class="">在死循环里，按固定间隔翻转引脚电平</li>
</ul>
<p>要直接操作外设，第一步是弄清楚：<strong>寄存器到底映射在内存的什么位置</strong>。翻开数据手册第 4 章 <em>Memory Mapping</em>，可以看到所有外设的基地址都从 <code>0x4000_0000</code> 开始，而 GPIOC 位于：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x4001 1000</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="periphral memory map" src="/sites/assets/images/periphral-memory-map-0f1fad61e7c30a6c634eda381393f1ff.png" width="867" height="1133" class="img_ev3q"></p>
<p>再看参考手册 3.3 <em>Memory map</em> 的 Table 3 Register boundary addresses (continued)，可以看到 GPIOC 挂在 <strong>APB2 总线</strong>，地址范围 <code>0x4001 1000 ~ 0x4001 13FF</code>，APB2 基地址是 <code>0x4001_0000</code>。</p>
<p><img decoding="async" loading="lazy" alt="periphra address" src="/sites/assets/images/periphral-register-address-61fd70977eb8994dd4a5a6fd8fd00100.png" width="1108" height="941" class="img_ev3q"></p>
<p>我们可以用 <code>APB2_BaseAddr + PeripheralOffset</code> 的方式定义该总线上外设的地址。</p>
<p>下面用宏来定义这些地址</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">PERIPHERAL_BASE</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0x40000000U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">APB2_BASE</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">PERIPHERAL_BASE </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0x10000U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">GPIOC_BASE</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">APB2_BASE </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0x1000U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>外设寄存器能不能用，关键不在地址，而在<strong>时钟有没有打开</strong>，GPIOC 的时钟控制位在 RCC 里。再次看参考手册 3.3 Memory map 中的表格 Table3. Register boundary addresses，可以看到 RCC 地址位于 <code>0x4002 1000 ~ 0x4002 13FF</code>，挂在 AHB 总线（<code>0x4001 8000</code>）上</p>
<p><img decoding="async" loading="lazy" alt="RCC address" src="/sites/assets/images/RCC-memory-map-1ab1d554eb414ba467b191b4711d0761.png" width="1100" height="666" class="img_ev3q"></p>
<p>先把这些地址也定义出来：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">AHB_BASE</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">PERIPHERAL_BASE </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0x18000U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">RCC_BASE</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">AHB_BASE </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0x9000U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>然后我们需要开启 GPIOC 的时钟，并把 PC13 配置为输出开漏模式。</p>
<p>先看看如何开启时钟，来看 RCC 寄存器，找到参考手册中的 APB2 外设时钟使能寄存器（8.3.7 APB2 peripheral clock enable register (RCC_APB2ENR) ），其偏移地址是 <code>0x18</code>，第 4 个 bit 是 GPIOC 时钟的开关。</p>
<p><img decoding="async" loading="lazy" alt="GPIOC address" src="/sites/assets/images/GPIOC-memory-map-2f08c91f165419c71dcd2767cc8d3274.png" width="1101" height="508" class="img_ev3q"></p>
<p>再往下翻一点，可以看到向该位写入 1 可以开启时钟</p>
<p><img decoding="async" loading="lazy" alt="GPIOC enable bit" src="/sites/assets/images/GPIOC-enable-bit-3a4958312c4195a4464de68138a2c452.png" width="371" height="119" class="img_ev3q"></p>
<p>继续定义一些外设时钟的地址，对应的宏可以这样写：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">RCC_APB2ENR_OFFSET</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0x18U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">RCC_APB2ENR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression keyword" style="color:#00009f">volatile</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">uint32_t</span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">RCC_BASE </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> RCC_APB2ENR_OFFSET</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">RCC_APB2ENR_GPIOCEN</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">4U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>接下来是 GPIO 本身的配置，我们需要配置其为输出开漏模式，并设置其初始状态为 1（熄灭 LED）。</p>
<p>这可以通过端口配置寄存器（GPIOx_CRL 和 GPIOx_CRH）和输出寄存器（GPIOx_ODR）来配置。</p>
<p>PC13 属于 8~15 号引脚，因此由 <code>GPIOx_CRH</code> 寄存器控制。</p>
<p>目标配置是：</p>
<ul>
<li class=""><code>MODE13 = 0b10</code> → 输出模式，最大 2 MHz</li>
<li class=""><code>CNF13  = 0b01</code> → 开漏输出</li>
</ul>
<p>合起来就是 <code>0b0110</code>，对应 CRH 中的 <strong>bit 20~23</strong>。</p>
<p><img decoding="async" loading="lazy" alt="GPIOx_CRH" src="/sites/assets/images/GPIOx_CRH-register-f9483fb46c09757e67c4fedd89bfa559.png" width="1099" height="959" class="img_ev3q"></p>
<p>由于 LED 是低电平点亮，所以还需要把输出寄存器里的 <code>ODR13</code> 先置 1，让 LED 默认熄灭。</p>
<p><img decoding="async" loading="lazy" alt="GPIOx_ODR" src="/sites/assets/images/GPIOx_ODR-b06f60dcc8cf4c33d454fdff4f419e97.png" width="1094" height="506" class="img_ev3q"></p>
<p>相关寄存器地址整理如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">GPIO_CRH_OFFSET</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0x04U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">GPIOC_CRH</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression keyword" style="color:#00009f">volatile</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">uint32_t</span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">GPIOC_BASE </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> GPIO_CRH_OFFSET</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">GPIO_CRH_MODE13_CNF13</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">20U</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">GPIO_ODR_OFFSET</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0x0CU</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">GPIOC_ODR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression keyword" style="color:#00009f">volatile</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">uint32_t</span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">GPIOC_BASE </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> GPIO_ODR_OFFSET</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">LED_PIN</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">13</span><br></span></code></pre></div></div>
<p>这里的寄存器指针都加了 <code>volatile</code>，目的是告诉编译器：<strong>这些内存访问有副作用，别擅自优化掉</strong>。如果对 <code>volatile</code> 不熟，这篇文章解释得很清楚：<a href="https://kleinembedded.com/the-volatile-qualifier/" target="_blank" rel="noopener noreferrer" class="">volatile 的作用</a></p>
<p>最后，开始写 <code>main()</code> 函数，万事俱备，代码就很直白了：</p>
<ol>
<li class="">
<p>打开 GPIOC 时钟</p>
</li>
<li class="">
<p>做两次 dummy read（芯片勘误建议）</p>
</li>
<li class="">
<p>配置 PC13 为开漏输出</p>
</li>
<li class="">
<p>在循环里翻转引脚电平，加个简单延时</p>
</li>
</ol>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 外设时钟使能</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RCC_APB2ENR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> RCC_APB2ENR_GPIOCEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// do two dummy reads after enabling the peripheral clock, as per the errata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> dummy</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dummy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RCC_APB2ENR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dummy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RCC_APB2ENR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">GPIOC_CRH </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> GPIO_CRH_MODE13_CNF13</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">GPIOC_ODR </span><span class="token operator" style="color:#393A34">^=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> LED_PIN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>至此，一个<strong>不依赖任何库、不用 CubeMX、不靠 HAL</strong> 的最小闪灯程序就完成了。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="构建可执行文件">构建可执行文件<a href="#构建可执行文件" class="hash-link" aria-label="Direct link to 构建可执行文件" title="Direct link to 构建可执行文件" translate="no">​</a></h3>
<p>到这里，源码已经齐活，可以开始把它们真正“捏”成一个能跑的程序了。前面提到过，其实<strong>没必要手动区分编译和链接</strong>，直接调用 <code>arm-none-eabi-gcc</code> 就行，它会自动完成整个流程：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ arm-none-eabi-gcc main.c startup.c -T linker_script.ld -o blink.elf -mcpu=cortex-m3 -mthumb -nostdlib</span><br></span></code></pre></div></div>
<p>这条命令做了几件事：</p>
<ul>
<li class=""><code>main.c startup.c</code>
直接把所有源文件丢给编译器。</li>
<li class=""><code>-T linker_script.ld</code>
指定自定义的链接脚本，告诉链接器内存该怎么排。</li>
<li class=""><code>-o blink.elf</code>
指定最终输出的可执行文件名。</li>
<li class=""><code>-mcpu=cortex-m3 -mthumb</code>
明确目标 CPU 架构和指令集（毕竟这是在给另一种 CPU 交叉编译）。</li>
<li class=""><code>-nostdlib</code>
不链接标准库，也不使用默认的系统启动代码——启动流程已经完全自己接管了。</li>
</ul>
<p>命令执行完成后，项目目录下会多出一个 <code>blink.elf</code> 文件。这个 ELF 文件，就是接下来要烧进 MCU 的“成品”。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="把程序加载到微控制器烧录">把程序加载到微控制器（烧录）<a href="#把程序加载到微控制器烧录" class="hash-link" aria-label="Direct link to 把程序加载到微控制器（烧录）" title="Direct link to 把程序加载到微控制器（烧录）" translate="no">​</a></h3>
<p>接下来轮到 OpenOCD 出场。OpenOCD 本身并不需要复杂配置，只要告诉它两件事就够了：</p>
<ul>
<li class="">
<p>使用什么<strong>编程器（interface）</strong></p>
</li>
<li class="">
<p>目标是什么<strong>微控制器（target）</strong></p>
</li>
</ul>
<p>编程器的配置在 <code>/usr/share/openocd/scripts/interface/</code> 中。目标微控制器型号在 <code>/usr/share/openocd/scripts/target/</code> 中。OpenOCD 在运行时会自动搜索这些目录，所以命令行只需要引用文件名即可。</p>
<p>要将 <code>.elf</code> 烧录到目标设备，只需要找到和我们的板子（STM32F103 + ST-Linkv2）匹配的配置（<code>interface/stlink.cfg</code> 和 <code>target/stm32f1x.cfg</code>），然后使用 <code>-c</code> 选项指定要执行的命令，完整的烧录命令如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ openocd -f interface/stlink.cfg -f target/stm32f1x.cfg -c &quot;program blink.elf verify reset exit&quot;</span><br></span></code></pre></div></div>
<p>这条命令一口气做了四件事：</p>
<ul>
<li class="">把 <code>blink.elf</code> 写入 Flash</li>
<li class="">校验写入内容是否正确</li>
<li class="">复位 MCU</li>
<li class="">干完活直接退出 OpenOCD</li>
</ul>
<p>如果一切顺利，命令跑完的同时，板子上的 LED 应该已经开始闪烁了。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="下节预告">下节预告<a href="#下节预告" class="hash-link" aria-label="Direct link to 下节预告" title="Direct link to 下节预告" translate="no">​</a></h3>
<p>纯手写寄存器、地址和位定义，虽然很“硬核”，但写多了确实挺折磨人的。接下来会稍微让事情轻松一点，引入 <strong>CMSIS</strong> 组件，用现成的寄存器定义来代替那些手写的宏——毕竟没必要每次都重复造轮子。同时，也会把那条又长又容易敲错的编译命令收拾一下，用经典的 Unix / Linux 构建工具 <strong><code>make</code></strong> 写一个简单的 <code>Makefile</code>，让构建过程变成一句命令的事。</p>
<h2 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="第-2-部分裸机编程之-arm-官方库-cmsis">第 2 部分：裸机编程之 ARM 官方库 CMSIS<a href="#第-2-部分裸机编程之-arm-官方库-cmsis" class="hash-link" aria-label="Direct link to 第 2 部分：裸机编程之 ARM 官方库 CMSIS" title="Direct link to 第 2 部分：裸机编程之 ARM 官方库 CMSIS" translate="no">​</a></h2>
<p>在上一节中，实现了一个最小可用的闪灯程序——这已经是 STM32 裸机运行所需的<strong>最小集合</strong>了。不过代价也很明显：外设寄存器地址全靠手翻手册，一个一个 <code>#define</code>；编译、链接、烧录全都直接在命令行里敲，参数又长又容易写错。</p>
<p>这一节的目标很明确：<strong>把这些“体力活”交给工具来做</strong>。为此，将引入：</p>
<ul>
<li class="">ARM 官方的 <strong>CMSIS Core</strong>（Cortex-M 内核相关定义）</li>
<li class="">ST 提供的 <strong>STM32F1 设备头文件</strong>（外设寄存器定义）</li>
<li class="">一个简单的 <strong>Makefile</strong>，让构建过程变成一句命令</li>
</ul>
<p>顺带还会配置系统时钟，把 LED 闪得更“专业”一点。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="cmsis-和寄存器定义">CMSIS 和寄存器定义<a href="#cmsis-和寄存器定义" class="hash-link" aria-label="Direct link to CMSIS 和寄存器定义" title="Direct link to CMSIS 和寄存器定义" translate="no">​</a></h3>
<p>回顾第一部分，当需要操作 GPIO 时，只能照着参考手册：</p>
<ul>
<li class="">查外设基地址</li>
<li class="">算寄存器偏移</li>
<li class="">手写一堆 <code>#define</code></li>
</ul>
<p>偶尔写写还能接受，如果每个外设都这么来，很快就会进入“复制—粘贴—怀疑人生”的阶段。好消息是，这件事早就有人替你做完了。</p>
<p><strong>CMSIS（Common Microcontroller Software Interface Standard）</strong> 是 ARM 为 Cortex-M 系列定义的一套标准组件集合，主要包括：</p>
<ul>
<li class="">Cortex-M 内核寄存器与核心外设定义</li>
<li class="">一些通用的内联函数与抽象接口</li>
<li class="">可选的 DSP / RTOS 相关支持</li>
</ul>
<p>在此基础上，ST 又提供了 <strong>STM32 的设备组件</strong>，把每个外设的寄存器都封装成了结构体和宏。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>相关仓库：</div><div class="admonitionContent_BuS1"><ul>
<li class="">CMSIS Core（内核定义）：<a href="https://github.com/ARM-software/CMSIS_5" target="_blank" rel="noopener noreferrer" class="">https://github.com/ARM-software/CMSIS_5</a></li>
<li class="">STM32F1 CMSIS Device（外设定义）：<a href="https://github.com/STMicroelectronics/cmsis-device-f1" target="_blank" rel="noopener noreferrer" class="">https://github.com/STMicroelectronics/cmsis-device-f1</a></li>
</ul></div></div>
<p>先在项目中创建一个 <code>vendor</code> 目录，用来放第三方代码。然后把 CMSIS Core 和 STM32F1 设备组件添加到我们的项目。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir vendor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd vendor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/ARM-software/CMSIS_5 CMSIS</span><br></span></code></pre></div></div>
<p>接下来，在 <code>CMSIS/Device</code> 下创建 ST 目录，并克隆 STM32F1 的设备组件：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd CMSIS/Device</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir ST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clone https://github.com/STMicroelectronics/cmsis_device_f1 STM32F1</span><br></span></code></pre></div></div>
<p>此时你可能已经注意到了，<strong>CMSIS 非常大</strong>（轻松几百 MB），因为它包含了所有架构、所有厂商的组件。</p>
<p>实际上这里只需要两部分：</p>
<ul>
<li class=""><code>CMSIS/CMSIS/Core</code></li>
<li class=""><code>CMSIS/Device/ST/STM32F1</code></li>
</ul>
<p>其他内容（包括 <code>.git</code> 目录）都可以放心删掉，完全不影响后续使用。</p>
<p>使用 CMSIS 后，访问寄存器的方式会发生质变。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;stm32f1xx.h&quot;</span><br></span></code></pre></div></div>
<p>这个头文件会根据 MCU 型号自动包含正确的设备定义（比如 <code>stm32f103xb.h</code>）。前提是 <strong>告诉编译器当前使用的具体芯片型号</strong>，可以通过：</p>
<ul>
<li class="">在代码中 <code>#define STM32F103xB</code></li>
<li class="">或在编译时使用 <code>-DSTM32F103xB</code></li>
</ul>
<p>有了这些定义，第一部分里那些手写的外设地址宏就可以全部删除了。修改后的 <code>main.c</code> 看起来会清爽很多：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;stm32f1xx.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdint.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 外设时钟使能</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">APB2ENR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> RCC_APB2ENR_IOPCEN_Pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// do two dummy reads after enabling the peripheral clock, as per the errata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> dummy</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dummy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">APB2ENR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dummy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">APB2ENR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GPIOC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CRH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CRH </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">GPIO_CRH_MODE13_Msk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GPIO_CRH_MODE13_1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GPIOC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CRH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CRH </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">GPIO_CRH_CNF13_Msk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GPIO_CRH_CNF13_0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIOC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ODR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ODR </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">GPIO_ODR_ODR13_Msk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GPIO_ODR_ODR13</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>代码本身做的事情没变，但可读性已经完全是另一个层级，现在不需要关心寄存器地址，不再手算 bit 位，一眼就能看出在操作哪个外设、哪个引脚。</p>
<p>引入 CMSIS 后，编译时需要额外告诉编译器：</p>
<ul>
<li class="">CMSIS Core 头文件路径</li>
<li class="">STM32F1 Device 头文件路径</li>
<li class="">当前使用的 MCU 型号</li>
</ul>
<p>完整的编译命令会变成这样：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">arm-none-eabi-gcc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  main.c startup.c \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vendor/CMSIS/Device/ST/STM32F1/Source/Templates/system_stm32f1xx.c \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -T linker_script.ld \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -o blink.elf \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Ivendor/CMSIS/CMSIS/Core/Include \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Ivendor/CMSIS/Device/ST/STM32F1/Include \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -mcpu=cortex-m3 -mthumb -nostdlib \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DSTM32F103xB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>这已经不是“顺手敲一行”的复杂度了。好在，这正是 <strong>Makefile</strong> 存在的意义。
下一步要做的，就是把这些参数收进规则里，让构建重新回到一句命令的状态。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="gnu-make-和-makefile">GNU Make 和 Makefile<a href="#gnu-make-和-makefile" class="hash-link" aria-label="Direct link to GNU Make 和 Makefile" title="Direct link to GNU Make 和 Makefile" translate="no">​</a></h3>
<p>GNU Make 是 Linux 世界里非常经典的一款自动化构建工具。如果平时用过 <code>autotools</code>，那对这一套流程应该不陌生：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./configure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make install</span><br></span></code></pre></div></div>
<p>简单来说，<code>make</code> 会读取一个名为 <code>Makefile</code> 的文件，根据里面写好的规则去调用 shell 命令完成构建。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>如果对 <code>Makefile</code> 感兴趣可以看下这篇博客：<a href="https://makefiletutorial.com/" target="_blank" rel="noopener noreferrer" class="">Learn Makefiles With the tastiest examples</a></p></div></div>
<p>在当前这个 STM32 裸机项目里，引入 Make 的意义非常直观：</p>
<ul>
<li class="">不用每次都手敲一大串 <code>arm-none-eabi-gcc</code> 参数</li>
<li class="">不用反复记 <code>openocd</code> 的接口和目标配置</li>
<li class="">构建、烧录都可以变成一句命令，比如：<!-- -->
<ul>
<li class=""><code>make</code></li>
<li class=""><code>make flash</code></li>
</ul>
</li>
</ul>
<p>另外一个经常被忽略、但非常重要的点是：<strong>Make 会自动判断哪些文件发生了变化，只重新编译必要的部分</strong>。项目规模一旦变大，这个特性就会变得非常香。</p>
<p>在 Arch Linux 中，<code>make</code> 随 <code>base-devel</code> 一起提供：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># pacman -S base-devel</span><br></span></code></pre></div></div>
<p>在项目根目录下创建一个名为 <code>Makefile</code>（注意没有扩展名）的文件。基本的语法结构如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">target: prerequisites</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	command</span><br></span></code></pre></div></div>
<p>其中：</p>
<ul>
<li class=""><code>target</code>：目标</li>
<li class=""><code>prerequisites</code>：依赖</li>
<li class=""><code>command</code>：要执行的命令（<strong>必须用 Tab 缩进</strong>）</li>
</ul>
<p>运行 <code>make target</code> 时，就会执行对应的规则。如果只运行 <code>make</code>，默认执行 Makefile 中的第一个目标，通常叫 <code>all</code>。</p>
<p>先把之前的命令直接“照搬”进来，写一个能用的版本：</p>
<div class="language-Makefile language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">all: blink.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blink.elf: main.c startup.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	arm-none-eabi-gcc main.c startup.c -T linker_script.ld -o blink.elf -Ivendor/CMSIS/CMSIS/Core/Include -Ivendor/CMSIS/Device/ST/STM32F1/Include -mcpu=cortex-m3 -mthumb -nostdlib -DSTM32F102xB -g -O0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flash: blink.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	openocd -f interface/stlink.cfg -f target/stm32f1x.cfg -c &quot;program blink.elf verify reset exit&quot;</span><br></span></code></pre></div></div>
<p>这已经能正常工作了：</p>
<ul>
<li class=""><code>make</code> → 生成 <code>blink.elf</code></li>
<li class=""><code>make flash</code> → 烧录到板子</li>
</ul>
<p>但说实话，这个 Makefile <strong>看起来有点糟</strong>，而且完全没发挥 Make 的优势。</p>
<p>Make 提供了大量约定俗成的变量，用来描述编译器和各类参数。
先把常用内容提取出来：</p>
<div class="language-Makefile language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CC=arm-none-eabi-gcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CFLAGS=-mcpu=cortex-m3 -mthumb -nostdlib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CPPFLAGS=-DSTM32F102xB \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	 -Ivendor/CMSIS/Device/ST/STM32F1/Include \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	 -Ivendor/CMSIS/CMSIS/Core/Include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LINKER_FILE=linker_script.ld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LDFLAGS=-T $(LINKER_FILE)</span><br></span></code></pre></div></div>
<p>这里用到的：</p>
<ul>
<li class=""><code>CC</code>：C 编译器</li>
<li class=""><code>CFLAGS</code>：编译选项</li>
<li class=""><code>CPPFLAGS</code>：预处理器选项（<code>-I</code>、<code>-D</code> 通常放这里）</li>
<li class=""><code>LDFLAGS</code>：链接选项</li>
</ul>
<p>这些都是 Make 的<a href="https://www.gnu.org/software/make/manual/html_node/Implicit-Variables.html" target="_blank" rel="noopener noreferrer" class=""><strong>隐式变量</strong></a>，后面即使用<a href="https://www.gnu.org/software/make/manual/html_node/Implicit-Rules.html" target="_blank" rel="noopener noreferrer" class=""><strong>隐式规则</strong></a>也能自动生效。为了直观起见，这里还是在规则里显式使用。</p>
<p>接下来，把“一步到位”的构建拆成更合理的几步：</p>
<ol>
<li class=""><code>.c</code> → <code>.o</code></li>
<li class="">多个 <code>.o</code> → <code>blink.elf</code></li>
</ol>
<div class="language-Makefile language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">all: blink.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blink.elf: main.o startup.o system_stm32f1xx.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) $^ -o blink.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.o: main.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$(CC) $(CFLAGS) $(CPPFLAGS) main.c -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">startup.o: startup.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$(CC) $(CFLAGS) $(CPPFLAGS) startup.c -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system_stm32f1xx.o: vendor/CMSIS/Device/ST/STM32F1/Source/Templates/system_stm32f1xx.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$(CC) $(CFLAGS) $(CPPFLAGS) vendor/CMSIS/Device/ST/STM32F1/Source/Templates/system_stm32f1xx.c -c</span><br></span></code></pre></div></div>
<p>这里有几个小细节值得注意：</p>
<ul>
<li class="">不指定 <code>-o</code> 时，<code>gcc</code> 会自动生成同名 <code>.o</code></li>
<li class=""><code>$^</code> 表示“所有依赖项”</li>
<li class=""><code>$&lt;</code> 表示“第一个依赖项”</li>
</ul>
<p>规则中以 <code>$</code> 开头的是<a href="https://www.gnu.org/software/make/manual/html_node/Automatic-Variables.html" target="_blank" rel="noopener noreferrer" class="">自动变量</a>，除了上面用的几个，还可以使用 <code>$@</code> 插入目标名称中作为输出文件名，但这里显式写出是为了保持简单。</p>
<p>第一次运行 <code>make</code>，会看到三个 <code>.o</code> 文件被生成，最后链接成 <code>blink.elf</code>。
如果立刻再运行一次：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make: 对“all”无需做任何事。</span><br></span></code></pre></div></div>
<p>这正是 Make 的价值所在——<strong>没有变化，就不浪费时间</strong>。</p>
<p>只改动 <code>main.c</code> 再运行 <code>make</code>，会发现只有 <code>main.o</code> 和 <code>blink.elf</code> 被重新生成。</p>
<p>再加一个常见的“伪目标”，伪目标只是一个不产生输出文件，而是只用于执行特定命令的目标。下面添加一个 <code>clean</code> 目标，用来清理输出文件 <code>.o</code> 和  <code>.elf</code> ：</p>
<div class="language-Makefile language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.PHONY: clean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clean:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	rm -f *.o *.elf</span><br></span></code></pre></div></div>
<p>现在，如果运行 <code>make clean</code> ，所有输出文件都将删除，如果再次运行 <code>make</code> 所有文件将再次构建。</p>
<p>最后，把 OpenOCD 也交给 Make 管理，用于一条命令把 <code>.elf</code> 文件烧录到 MCU：</p>
<div class="language-Makefile language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PROGRAMMER=openocd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PROGRAMMER_FLAGS=-f interface/stlink.cfg -f target/stm32f1x.cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flash: blink.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$(PROGRAMMER) $(PROGRAMMER_FLAGS) -c &quot;program blink.elf verify reset exit&quot;</span><br></span></code></pre></div></div>
<p>从现在开始，日常流程就变成了：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make flash</span><br></span></code></pre></div></div>
<p>参数、路径、配置文件都被锁进了 Makefile，既省事，也不容易出错。到这里，裸机开发的“基础设施”已经逐渐成型了。下一步，就是开始折腾时钟配置，让 MCU 跑得更快。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="时钟配置">时钟配置<a href="#时钟配置" class="hash-link" aria-label="Direct link to 时钟配置" title="Direct link to 时钟配置" translate="no">​</a></h3>
<p>前面已经把构建系统搭好，也能方便地访问所有核心和外设寄存器了。接下来要做的事情很简单：<strong>把 MCU 的性能榨干一点</strong>，把系统时钟拉到 STM32F1 能跑的最高频率 —— <strong>72 MHz</strong>。</p>
<p>默认情况下，STM32 使用的是高速内部振荡器（HSI），这是一个 <strong>8 MHz 的 RC 振荡器</strong>。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p><img decoding="async" loading="lazy" alt="clock-and-startup" src="/sites/assets/images/clock-and-startup-84a09721eea9c48b15c271a9c9212e49.png" width="1611" height="518" class="img_ev3q"></p></div></div>
<p>HSI 的优点是省事，但精度一般。如果板子上有更靠谱的外部晶振，那显然更适合拿来当系统时钟。</p>
<h4 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="使用高速外部hse振荡器">使用高速外部（HSE）振荡器<a href="#使用高速外部hse振荡器" class="hash-link" aria-label="Direct link to 使用高速外部（HSE）振荡器" title="Direct link to 使用高速外部（HSE）振荡器" translate="no">​</a></h4>
<p>HSE 可以通过 <code>OSC_IN / OSC_OUT</code> 接一颗晶体振荡器，或者直接从 <code>OSC_IN</code> 输入一个外部时钟信号。这里使用的是开发板上自带的 <strong>8 MHz 晶振</strong>。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>HSE 的两种来源</div><div class="admonitionContent_BuS1"><p><img decoding="async" loading="lazy" alt="HSE clock sources" src="/sites/assets/images/HES-clock-sources-8c209291b46a9e4e9de901d2db47af41.png" width="1223" height="769" class="img_ev3q"></p></div></div>
<p>第一步是把 HSE 启动起来：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Step 1：启用 HSE 晶振</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 确保 HSEBYP = 0 → 晶振模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CR </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">RCC_CR_HSEBYP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 开启 HSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_CR_HSEON</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 等待 HSE 就绪</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CR </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> RCC_CR_HSERDY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>到这里，已经有了一个<strong>精度不错的 8 MHz 时钟源</strong>。接下来要做的，就是把它放大到 72 MHz。不过在拉高频率之前，还有一件很容易被忽略、但非常关键的事情要先处理。</p>
<h4 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="闪存延迟flash-wait-states">闪存延迟（Flash Wait States）<a href="#闪存延迟flash-wait-states" class="hash-link" aria-label="Direct link to 闪存延迟（Flash Wait States）" title="Direct link to 闪存延迟（Flash Wait States）" translate="no">​</a></h4>
<p>CPU 的取指是通过 AHB 总线从 Flash 里读的。问题在于：</p>
<ul>
<li class="">CPU 主频越高，取指越快</li>
<li class="">Flash 的访问速度却不会跟着变快</li>
</ul>
<p>如果不加等待周期，CPU 会跑得比 Flash 还快，结果就是<strong>指令读乱、程序直接跑飞（字面意义上的飞）</strong>。</p>
<p>参考手册里已经给了答案：</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>3.3.3 Reading the Flash Memory</div><div class="admonitionContent_BuS1"><p><img decoding="async" loading="lazy" alt="flash latency" src="/sites/assets/images/flash-memory-latency-25887e9b243f62fec547277220fe3c28.png" width="1337" height="794" class="img_ev3q"></p></div></div>
<p>当 <code>48 &lt; SYSCLK &lt;= 72 MHz</code> 时，Flash 等待周期需要设置为 <strong>2 个 WS</strong>。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Step 2：配置 Flash 延迟（72 MHz 对应 2 WS）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 参考手册，72 MHz HCLK，VDD=3.3V → FLASH_LATENCY_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FLASH-&gt;ACR &amp;= ~FLASH_ACR_LATENCY;        // 清零延迟位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FLASH-&gt;ACR |= FLASH_ACR_LATENCY_2;       // 设置2个等待状态</span><br></span></code></pre></div></div>
<p>这一步一定要<strong>在切换高频时钟之前完成</strong>。</p>
<h4 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="利用锁相环pll提高时钟频率">利用锁相环（PLL）提高时钟频率<a href="#利用锁相环pll提高时钟频率" class="hash-link" aria-label="Direct link to 利用锁相环（PLL）提高时钟频率" title="Direct link to 利用锁相环（PLL）提高时钟频率" translate="no">​</a></h4>
<p>真正把频率拉上去的核心，是 MCU 里的<strong>锁相环（Phase-Lock Loop, PLL）</strong>。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>确定时钟树参数</div><div class="admonitionContent_BuS1"><p>如果目标是让 CPU 跑满 72 MHz，最省事的方式其实是先打开 <strong>STM32CubeMX</strong>，在 Clock Configuration 页面里直接把 <code>HCLK</code> 填成 72。CubeMX 会自动帮忙算好：</p><ul>
<li class="">PLL 倍频系数</li>
<li class="">AHB / APB 分频</li>
<li class="">SYSCLK 的来源</li>
</ul><p>接下来只需要照着这个结果，用寄存器手动配置一遍即可。</p><p><img decoding="async" loading="lazy" alt="STM32CubeMX clock configuration" src="/sites/assets/images/STM32CubeMX-clock-configuration-de263893cb5f440997695a269e7d939c.png" width="1657" height="1179" class="img_ev3q"></p></div></div>
<p>我们来看一下参考手册里的时钟树。为了实现 <strong>72MHz</strong> 的满速运行，配置路径是这样的：首先看左下角的锁相环 <strong>PLLMUL</strong>，它能通过 <strong>PLLSRC</strong> 复用器从 <strong>HSI</strong> 或 <strong>HSE</strong>（经 <strong>PLLXTPRE</strong> 预分频）中二选一作为输入。PLL 的输出即为系统时钟 <strong>SYSCLK</strong>。该时钟经过 <strong>AHB 预分频器</strong> 后，直接驱动 CPU 核心（即 <strong>HCLK</strong>），并继续分频给 <strong>APB1</strong> 和 <strong>APB2</strong>。需特别注意，<strong>APB1 的频率上限为 36MHz</strong>。</p>
<p><img decoding="async" loading="lazy" alt="Clock Tree" src="/sites/assets/images/clock-tree-35f0c8d73979322f2701b1ff767d69cf.png" width="1417" height="1577" class="img_ev3q"></p>
<p>通过 STM32CubeMX 我们已经知道了配置时钟树需要的所有参数，下面我们来配置</p>
<p>整体流程可以概括成这样：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[启用 HSE] → 等待稳定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[配置 Flash 延迟]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[配置 PLL] → 关 PLL → 设参数 → 开 PLL → 等待稳定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[配置 AHB / APB 分频]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[切换 SYSCLK 到 PLL]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[更新 SystemCoreClock]</span><br></span></code></pre></div></div>
<p>对应的代码如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Step 3：配置 PLL（倍频器 + 时钟源）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 禁用 PLL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CR </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">RCC_CR_PLLON</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CR </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> RCC_CR_PLLRDY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// 等待 PLL 关闭</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 设置 PLL 来源和倍频</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// PLLSRC = HSE, PLLXTPRE = HSE预分频, PLLMUL = x9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RCC_CFGR_PLLSRC </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> RCC_CFGR_PLLXTPRE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> RCC_CFGR_PLLMULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_CFGR_PLLSRC</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// HSE 作为 PLL 输入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_CFGR_PLLMULL9</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// PLL 倍频 9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 开启 PLL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_CR_PLLON</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CR </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> RCC_CR_PLLRDY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 等待 PLL 就绪</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Step 4：配置 AHB / APB 分频器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// HCLK = SYSCLK / 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">RCC_CFGR_HPRE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_CFGR_HPRE_DIV1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// PCLK1 = HCLK / 2 (APB1最大36MHz)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">RCC_CFGR_PPRE1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_CFGR_PPRE1_DIV2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// PCLK2 = HCLK / 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">RCC_CFGR_PPRE2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_CFGR_PPRE2_DIV1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Step 5：切换 SYSCLK 到 PLL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 切换 SYSCLK 到 PLL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">RCC_CFGR_SW</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// 清 SW 位</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_CFGR_SW_PLL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// SYSCLK = PLL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 等待切换完成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CFGR </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> RCC_CFGR_SWS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> RCC_CFGR_SWS_PLL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Step 6：更新 SystemCoreClock（CMSIS）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">SystemCoreClockUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>这部分代码通常会单独丢进一个 <code>clock_init()</code> 函数，在 <code>main()</code> 里调用。
<code>SystemCoreClockUpdate()</code> 现在看起来没啥用，但之后一旦用到 HAL 或 SysTick，就离不开它了。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>时钟树配置寄存器</div><div class="admonitionContent_BuS1"><p>STM32F1 的时钟配置主要集中在两个寄存器： <code>RCC_CR</code> 和 <code>RCC_CFGR</code>。一个用于配置时钟来源，另一个用于配置预分频器系数。</p><ul>
<li class="">
<p><code>RCC_CR</code> — 控制寄存器 (Clock Control Register)：控制时钟源的开关、提供就绪状态标志</p>
</li>
<li class="">
<p><img decoding="async" loading="lazy" alt="RCC_CR" src="/sites/assets/images/RCC_CR-ba8c02477f8365dfc7ce70f205cded45.png" width="1357" height="529" class="img_ev3q"></p>
<ul>
<li class=""><code>HSION</code> / <code>HSIRDY</code> — 内部高速振荡器开关与就绪标志</li>
<li class=""><code>HSEON</code> / <code>HSERDY</code> — 外部高速晶振开关与就绪标志</li>
<li class=""><code>PLLON</code> / <code>PLLRDY</code> — PLL 开关与就绪标志</li>
</ul>
</li>
<li class="">
<p><code>RCC_CFGR</code> — 时钟配置寄存器 (Clock Configuration Register)：选择 SYSCLK 来源、设置 AHB / APB 分频、配置 PLL 参数</p>
<p><img decoding="async" loading="lazy" alt="RCC_CRGR" src="/sites/assets/images/RCC_CFGR-3853f986b3ca31f4690597eefd797fa8.png" width="1616" height="669" class="img_ev3q"></p>
<ul>
<li class=""><code>SW</code> / <code>SWS</code> — 系统时钟选择及就绪状态</li>
<li class=""><code>HPRE</code> — AHB 分频</li>
<li class=""><code>PPRE1</code> / <code>PPRE2</code> — APB1 / APB2 分频</li>
<li class=""><code>PLLSRC</code>, <code>PLLMUL</code> — PLL 输入源与倍频系数</li>
</ul>
</li>
</ul></div></div>
<p>如果这时执行 <code>make flash</code>，会发现 LED 闪得明显快了一截 —— 说明主频确实拉上来了。</p>
<h4 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="使用-systick-验证时钟频率">使用 SysTick 验证时钟频率<a href="#使用-systick-验证时钟频率" class="hash-link" aria-label="Direct link to 使用 SysTick 验证时钟频率" title="Direct link to 使用 SysTick 验证时钟频率" translate="no">​</a></h4>
<p>为了确认 72 MHz 真的生效了，这里用 <strong>Cortex-M3 的 SysTick</strong> 做一个简单的毫秒级定时。思路很直接，让 SysTick <strong>每 1 ms 触发一次中断</strong>，然后在中断里递增一个计数器并利用用这个计数器实现延时函数。</p>
<p>CMSIS 已经封装好了 <code>SysTick_Config()</code> 函数，我们只需传入两次中断之间的计数值（Ticks）即可。既然系统时钟已配置为 <strong>72MHz</strong>，若要实现 <strong>1kHz</strong> 的中断频率（即每秒中断 1,000 次），计算得出两次中断的间隔应为：</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>72</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn><mo>÷</mo><mn>1</mn><mo separator="true">,</mo><mn>000</mn><mo>=</mo><mn>72</mn><mo separator="true">,</mo><mn>000</mn><mtext> Ticks</mtext></mrow><annotation encoding="application/x-tex">72,000,000 \div 1,000 = 72,000 \text{ Ticks}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">72</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">÷</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">72</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">000</span><span class="mord text"><span class="mord"> Ticks</span></span></span></span></span></p>
<p>随后，在代码中调用该函数并确保全局中断已启用，代码如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">SysTick_Config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">72000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">__enable_irq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>启动文件里已经把 SysTick 中断指向了弱符号 <code>default_handler()</code>，直接在 <code>main.c</code> 里覆盖即可：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">uint32_t</span><span class="token plain"> ticks</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">systick_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ticks</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>接下来，编写一个延迟函数，只是简单地等待所需毫秒数</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">delay_ms</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token plain"> milliseconds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">uint32_t</span><span class="token plain"> start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ticks</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">uint32_t</span><span class="token plain"> end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> milliseconds</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">end </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle overflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ticks </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// wait for ticks to wrap around to zero</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ticks </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>最后，在主循环中，使用这个新的延迟函数 <code>delay_ms()</code> 来闪烁 LED：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIOC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ODR </span><span class="token operator" style="color:#393A34">^=</span><span class="token plain">  GPIO_ODR_ODR13_Msk</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">delay_ms</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>如果一切正常，现在 LED 应该以<strong>接近 1 Hz 的频率</strong>稳定闪烁。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="下节预告-1">下节预告<a href="#下节预告-1" class="hash-link" aria-label="Direct link to 下节预告" title="Direct link to 下节预告" translate="no">​</a></h3>
<p>第 3 部分会把 <strong>C 标准库</strong>引入项目，顺便折腾一下 <code>printf()</code>，看看在裸机环境下如何做一点像样的调试输出。</p>
<h2 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="第-3-部分裸机编程之-c--标准库和-printf">第 3 部分：裸机编程之 C  标准库和 <code>printf()</code><a href="#第-3-部分裸机编程之-c--标准库和-printf" class="hash-link" aria-label="Direct link to 第-3-部分裸机编程之-c--标准库和-printf" title="Direct link to 第-3-部分裸机编程之-c--标准库和-printf" translate="no">​</a></h2>
<p>在第 2 部分中，我们通过 Makefile 配置了时钟系统，并成功运行了基础的闪灯程序。到目前为止，我们一直给 GCC 传递 <code>-nostdlib</code> 参数，在<strong>完全不依赖 C 标准库</strong>的情况下构建项目。</p>
<p>这一节要做的事情很明确：</p>
<ul>
<li class="">把 <strong>C 标准库</strong>引入裸机项目。</li>
<li class="">让 <code>printf()</code> 能通过 <strong>UART 输出到主机</strong>，方便调试。</li>
</ul>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="c-标准库">C 标准库<a href="#c-标准库" class="hash-link" aria-label="Direct link to C 标准库" title="Direct link to C 标准库" translate="no">​</a></h3>
<p>如果平时在 PC 上用 <code>gcc</code> 编译 C 程序，默认链接的多半是 <strong>glibc</strong>。它功能很全，但体积动辄几 MB，对微控制器来说基本不可用。</p>
<p>嵌入式世界里更常见的是 <strong>Newlib</strong>，它专为资源受限系统设计，且已集成在 GNU Arm Toolchain 中。即便如此，Newlib 的全功能版体积依然不小。为此，工程实践中往往会选择其极致精简版：<strong>Newlib-nano</strong>（也称 Nanolib）。它的代码尺寸明显更小，并且占用更少的 RAM，但它默认移除了 <code>printf()</code> / <code>scanf()</code> 对浮点数的格式化支持。如果需要打印浮点数，必须显式开启编译选项。</p>
<p>为了直观感受差异，这里把同一个闪灯程序分别用不同配置编译了一遍，分别是没有标准库、Newlib 和 Newlib-nano。并用 <code>arm-none-eabi-size</code> 查看结果。<strong>没有开启任何编译优化</strong>。</p>
<p>不使用 C 标准库（<code>-nostdlib</code>），只有最原始的闪灯逻辑：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ arm-none-eabi-size blink.elf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   text    data     bss     dec     hex filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   1056     340       4    1400     578 blink.elf</span><br></span></code></pre></div></div>
<p>使用 Newlib（移除 <code>-nostdlib</code>），并把 <code>printf()</code> 重定向到 USART：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ arm-none-eabi-size blink.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   text    data     bss     dec     hex filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  37132    2112     852   40096    9ca0 blink.elf</span><br></span></code></pre></div></div>
<p>使用 Newlib-nano（<code>--specs=nano.specs</code>）</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">arm-none-eabi-size blink.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   text    data     bss     dec     hex filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   9940     456     520   10916    2aa4 blink.elf</span><br></span></code></pre></div></div>
<p>给 <code>printf()</code> 加上浮点支持（<code>-u _printf_float</code>）后</p>
<p>使用 <strong>Newlib-nano</strong> 时的结果：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">arm-none-eabi-size blink.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   text    data     bss     dec     hex filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  20796     820     524   22140    567c blink.elf</span><br></span></code></pre></div></div>
<p>再对比一下 <strong>标准 Newlib</strong>：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">arm-none-eabi-size blink.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   text    data     bss     dec     hex filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  37132    2112     852   40096    9ca0 blink.elf</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="添加-newlib-nano">添加 Newlib-nano<a href="#添加-newlib-nano" class="hash-link" aria-label="Direct link to 添加 Newlib-nano" title="Direct link to 添加 Newlib-nano" translate="no">​</a></h3>
<p>要使用 Newlib-nano，其实不需要手动指定库文件，只要<strong>告诉 <code>gcc</code> 用哪一套 specs</strong> 即可。具体做法是，不再使用 <code>-nostdlib</code>，而是在编译和链接参数中加入 <code>--specs=nano.specs</code> 选项 。<code>nano.specs</code> 文件已经包含在工具链中。在 Arch Linux 上，通常位于： <code>/usr/arm-none-eabi/lib</code>。</p>
<p>后面会把 <code>printf()</code> 重定向到 UART。如果改用<strong>半主机模式</strong>，还可以额外加上 <code>--specs=rdimon.specs</code> 标志。简单说，半主机允许目标板通过调试器，直接和主机通信（比如把 <code>printf()</code> 打到 GDB 终端）。但它有一个很大的限制：只要调试器断开，程序就跑不起来。如果想深入了解，可以看看这篇文章：<a href="https://interrupt.memfault.com/blog/arm-semihosting" target="_blank" rel="noopener noreferrer" class="">Introduction to ARM Semihosting</a>。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="系统调用">系统调用<a href="#系统调用" class="hash-link" aria-label="Direct link to 系统调用" title="Direct link to 系统调用" translate="no">​</a></h3>
<p>在加入 <code>nano.specs</code> 之后直接运行 <code>make</code>，<code>gcc</code> 大概率会开始报错，常见的包括：</p>
<ul>
<li class="">链接符号找不到：<code>__bss_start</code>、<code>__bss_end</code></li>
<li class="">系统调用未定义：<code>_read</code>、<code>_write</code>、<code>_sbrk</code> 等</li>
</ul>
<p><code>__bss_start</code> 和 <code>__bss_end</code> 用来标记 <code>.bss</code> 段的起止位置。链接脚本里其实已经有 <code>_sbss</code> 和 <code>_ebss</code> 了，只是名字对不上而已。最简单的办法：<strong>直接别名过去</strong>。</p>
<p>在链接脚本中把 <code>.bss</code> 段改成这样：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">linker_script</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bss </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _sbss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __bss_start__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _sbss</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bss</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _ebss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __bss_end__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _ebss</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">SRAM</span><br></span></code></pre></div></div>
<p>剩下那几个 <code>_read</code>、<code>_write</code>、<code>_sbrk</code> 报错，原因是 <strong>Newlib 并不知道你的硬件长什么样</strong>。这些函数是 <strong>C 库和底层硬件之间的接口</strong>，必须由用户提供实现。好消息是，并不需要全部实现，只要给一个“能用的最小版本”就行。</p>
<p>Newlib 官方文档里列出了推荐的最小实现集合：<a href="https://sourceware.org/newlib/libc.html#Stubs" target="_blank" rel="noopener noreferrer" class="">https://sourceware.org/newlib/libc.html#Stubs</a></p>
<p>直接复制一份放到项目根目录，命名为 <code>syscalls.c</code>。然后在 <code>Makefile</code> 里把它加进构建流程：</p>
<div class="language-Makefile language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Makefile</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$(BINARY): main.o startup.o system_stm32f4xx.o syscalls.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o $(BINARY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syscalls.o: syscalls.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$(CC) $(CFLAGS) $(CPPFLAGS) $^ -c</span><br></span></code></pre></div></div>
<p>调用 <code>printf()</code> 时，格式化字符最终会由 <code>_write()</code> 系统调用，通过 UART 发送到主机。在设置好 UART 之前，将其留空即可。</p>
<p>此外，由于标准库的 <code>printf()</code> 内部涉及动态内存分配，我们必须实现 <code>_sbrk()</code> 函数（供 <code>malloc()</code> 调用）以管理 <strong>堆（Heap）</strong> 空间。可以简单回忆一下内存布局：</p>
<ul>
<li class=""><code>.bss</code> 和 <code>.data</code> 在 SRAM 底部</li>
<li class=""><strong>堆（heap）</strong>：从 <code>.bss</code> 结束处向上增长</li>
<li class=""><strong>栈（stack）</strong>：从 SRAM 顶部向下增长</li>
</ul>
<p>由于堆与栈是“相向而行”的，存在相互碰撞（溢出）的风险——这不太好，所以需要在 <code>_sbrk()</code> 中加入简单的边界检查，一旦堆和栈撞车，直接死循环。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">register</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> stack_ptr </span><span class="token keyword" style="color:#00009f">asm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;sp&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">caddr_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_sbrk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> incr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> __bss_end__</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Defined by the linker */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">heap_end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prev_heap_end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heap_end </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    heap_end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">__bss_end__</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prev_heap_end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> heap_end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heap_end </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> incr </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> stack_ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Heap and stack collision</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  heap_end </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> incr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">caddr_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> prev_heap_end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>如果对动态内存分配本身就不放心，其实可以直接绕开它。有不少只用静态内存的 <code>printf()</code> 实现，比如 <a href="https://github.com/mpaland/printf" target="_blank" rel="noopener noreferrer" class="">Marco Paland 的方案</a>，配置非常简单，也很好用。</p></div></div>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="初始化库">初始化库<a href="#初始化库" class="hash-link" aria-label="Direct link to 初始化库" title="Direct link to 初始化库" translate="no">​</a></h3>
<p>把库链接进来还不够，<strong>它还需要被初始化</strong>。这一步由 <code>__libc_init_array()</code> 完成，必须在 <code>main()</code> 之前调用。在启动文件中加上声明，并在 <code>reset_handler()</code> 里调用：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">startup.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__libc_init_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reset_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ... .data/.bss initialization left out</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">__libc_init_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="修订链接脚本">修订链接脚本<a href="#修订链接脚本" class="hash-link" aria-label="Direct link to 修订链接脚本" title="Direct link to 修订链接脚本" translate="no">​</a></h3>
<p>现在项目已经能编译了，但如果用 <code>arm-none-eabi-objdump -h blink.elf</code> 查看段信息，会发现多了不少新 section 我们需要根据段的类型，将这些 section 添加到 <code>.text</code>、<code>.data</code> 或者 <code>.bss</code> 中。这一点很重要，因为启动代码依赖链接脚本定义的符号来定位 <code>.data</code> 和 <code>.bss</code>，如果不显式地将新段分配到正确的存储区域，这些数据在运行时将无法正确初始化。在链接脚本中，这三个段是这样的：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">linker_script.ld</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rodata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rodata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">KEEP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">KEEP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fini</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eh_frame</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ARM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exidx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _etext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">FLASH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  _sidata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">LOADADDR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _sdata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">KEEP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init_array</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">KEEP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fini_array</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _edata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">SRAM AT</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> FLASH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bss </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _sbss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __bss_start__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _sbss</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bss</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bss</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _ebss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __bss_end__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _ebss</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">SRAM</span><br></span></code></pre></div></div>
<p><code>KEEP()</code> 关键字可以强制链接器保留特定的初始化向量，防止其在链接优化阶段被剔除。顺便还加了一个更稳妥的符号 <code>_sidata</code>，利用链接脚本中的 <code>LOADADDR</code> 显式获取 <code>.data</code> 段在 Flash 中的物理加载地址。相比直接引用 <code>.text</code> 段结束位置的 <code>_etext</code>，这种方式在内存布局复杂（如存在多个执行段）时更为稳妥。然后同步更新启动代码（Startup Code）中的数据搬运逻辑，将原本拷贝数据时的源地址指针从 <code>_etext</code> 修改为 <code>_sidata</code>。</p>
<p>现在终于可以在在 <code>main.c</code> 中通过 <code>#include &lt;stdio.h&gt;</code> 调用标准 <code>printf()</code> 了。此时编译并烧录固件，LED 应当能正常闪烁。由于此时尚未实现底层的 <code>_write()</code> 系统调用，串口暂时不会有任何数据输出。稍后我们会处理这个问题。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="设置-uart">设置 UART<a href="#设置-uart" class="hash-link" aria-label="Direct link to 设置 UART" title="Direct link to 设置 UART" translate="no">​</a></h3>
<p>在当前开发板上，<strong>USART3</strong> 的引脚分配为 <strong>PB10 (TX)</strong> 和 <strong>PB11 (RX)</strong> 两个引脚，通过一个外部的 TTL-to-USB 模块与 PC 进行通信。USART 本身并不十分复杂，翻一翻参考手册就能发现，真正需要关心的寄存器并不多：主要是控制寄存器 <strong><code>USART_CR1</code></strong> 和波特率寄存器 <strong><code>USART_BRR</code></strong>。在发送数据时，还需要查看状态寄存器 <strong><code>USART_SR</code></strong>，并通过数据寄存器 <strong><code>USART_DR</code></strong> 写入要发送的内容。初始化 USART 大致需要完成下面几步：</p>
<ul>
<li class="">打开 <strong>USART3</strong> 和 <strong>GPIOB</strong> 的外设时钟</li>
<li class="">将对应的 GPIO 引脚配置为复用功能，分别作为 TX 和 RX</li>
<li class="">设置波特率（这里使用常见的 <strong>115200</strong>）</li>
</ul>
<p>为了让结构更清晰，这里单独创建一个模块：<code>usart.h</code> 和 <code>usart.c</code>，把所有和 USART 相关的代码都集中放在这里，并提供一个统一的初始化接口 <code>usart_init()</code>。</p>
<p>第一步是启用外设时钟，根据 STM32 的时钟树架构，USART3 挂载在 <strong>APB1</strong> 总线上，而其对应的引脚 GPIOB 则位于 <strong>APB2</strong> 总线。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">APB1ENR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_APB1ENR_USART3EN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 开启 USART3 时钟</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// do two dummy reads after enabling the peripheral clock, as per the errata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> dummy</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dummy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">APB1ENR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dummy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">APB1ENR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">APB2ENR </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> RCC_APB2ENR_IOPBEN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 开启 GPIOB 时钟</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// do two dummy reads after enabling the peripheral clock, as per the errata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dummy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">APB2ENR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dummy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">APB2ENR</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>对于串口通信，引脚必须切换至特定的复用功能模式。其中，<strong>PB10 (TX)</strong> 配置为 <strong>复用推挽输出 (Alternate Function Push-Pull)</strong>，<strong>PB11 (RX)</strong> 配置为 <strong>浮空输入 (Floating Input)</strong>。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 配置 PB10 (TX) 为复用推挽输出，50MHz 速度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GPIOB</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CRH </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIO_CRH_CNF10 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GPIO_CRH_MODE10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GPIOB</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CRH </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIO_CRH_CNF10_1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GPIO_CRH_MODE10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 配置 PB11 (RX) 为浮空输入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GPIOB</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CRH </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIO_CRH_CNF11 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GPIO_CRH_MODE11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GPIOB</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">CRH </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIO_CRH_CNF11_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span></code></pre></div></div>
<p>接下来是配置波特率，这里设置为常用的 <strong>115200</strong>。</p>
<p>USART 的波特率由 BRR 寄存器决定，计算公式如下：</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>a</mi><mi>u</mi><mi>r</mi><mi>d</mi><mi>R</mi><mi>a</mi><mi>t</mi><mi>e</mi><mo>=</mo><mfrac><msub><mi>f</mi><mrow><mi>C</mi><mi>K</mi></mrow></msub><mrow><mo stretchy="false">(</mo><mn>16</mn><mo>×</mo><mi>U</mi><mi>S</mi><mi>A</mi><mi>R</mi><mi>T</mi><mi>D</mi><mi>I</mi><mi>V</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">BaurdRate=\frac{f_{CK}}{(16×USARTDIV)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.4522em;vertical-align:-0.52em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">16</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.10903em">U</span><span class="mord mathnormal mtight" style="margin-right:0.05764em">S</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.13889em">RT</span><span class="mord mathnormal mtight" style="margin-right:0.02778em">D</span><span class="mord mathnormal mtight" style="margin-right:0.07847em">I</span><span class="mord mathnormal mtight" style="margin-right:0.22222em">V</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.4461em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3567em;margin-left:-0.1076em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span><span class="mord mathnormal mtight" style="margin-right:0.07153em">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
<p>在系统主频为 <strong>72 MHz</strong> 的情况下，<strong>APB1</strong> 的最高时钟频率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mrow><mi>C</mi><mi>K</mi></mrow></msub></mrow><annotation encoding="application/x-tex">f_{CK}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span><span class="mord mathnormal mtight" style="margin-right:0.07153em">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 为 <strong>36 MHz</strong>。代入计算：</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mi>S</mi><mi>A</mi><mi>R</mi><mi>T</mi><mi>D</mi><mi>I</mi><mi>V</mi><mo>=</mo><mfrac><mrow><mn>36</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn></mrow><mrow><mn>16</mn><mo>×</mo><mn>115</mn><mo separator="true">,</mo><mn>200</mn></mrow></mfrac><mo>≈</mo><mn>19.53125</mn></mrow><annotation encoding="application/x-tex">USARTDIV=\frac{36,000,000}{16 \times 115,200}≈19.53125</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.13889em">RT</span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mord mathnormal" style="margin-right:0.07847em">I</span><span class="mord mathnormal" style="margin-right:0.22222em">V</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.3783em;vertical-align:-0.4811em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8972em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">16</span><span class="mbin mtight">×</span><span class="mord mtight">115</span><span class="mpunct mtight">,</span><span class="mord mtight">200</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.4461em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">36</span><span class="mpunct mtight">,</span><span class="mord mtight">000</span><span class="mpunct mtight">,</span><span class="mord mtight">000</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4811em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">19.53125</span></span></span></span></p>
<ul>
<li class=""><strong>整数部分（Mantissa）</strong>：19（<code>0x13</code>），占高 12 位</li>
<li class=""><strong>小数部分（Fraction）</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.53125</mn><mo>×</mo><mn>16</mn><mo>≈</mo><mn>8.5</mn></mrow><annotation encoding="application/x-tex">0.53125 \times 16 \approx 8.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">0.53125</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">16</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">8.5</span></span></span></span>，四舍五入后取 <strong>9</strong>，占低 4 位</li>
</ul>
<p>然后把值写入 BBR 中：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">USART3-&gt;BRR = (19 &lt;&lt; 4) | 9; // 设置波特率寄存器</span><br></span></code></pre></div></div>
<p>最后一步就是使能 USART 本身，同时使能发送和接收功能：：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">USART3-&gt;CR1 |= (USART_CR1_UE | USART_CR1_TE | USART_CR1_RE); // 使能 USART、发送和接收</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="将-printf-重定向到-uart">将 <code>printf()</code> 重定向到 UART<a href="#将-printf-重定向到-uart" class="hash-link" aria-label="Direct link to 将-printf-重定向到-uart" title="Direct link to 将-printf-重定向到-uart" translate="no">​</a></h3>
<p>既然标准库已经接进来了，USART 也能正常工作了，下一步自然就是让 <code>printf()</code> 真正跑起来。关键点在于实现 <code>_write()</code>，让标准输出知道“该往哪儿写”。</p>
<p>这里先采用一种最直接、也最原始的方式：每次发送一个字符，就把它写进 USART 的数据寄存器，然后一直等到发送完成标志被置位再返回。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">usart_write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">USART_TypeDef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">usart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    usart</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">DR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">usart</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">SR </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> USART_SR_TC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>这种写法效率并不高，但作为概念验证已经完全够用了。等以后追求性能，再去折腾中断或者 DMA 也不迟。</p>
<p>接下来回到 <code>main()</code>，加上对 <code>usart_init()</code> 的调用，然后在主循环里用 <code>printf()</code> 打印一行带时间戳的 <code>&quot;Hello, World!&quot;</code>，顺便验证一下格式输出是否正常：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">usart_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">USART3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIOC</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ODR </span><span class="token operator" style="color:#393A34">^=</span><span class="token plain"> GPIO_ODR_ODR13_Msk</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;[%d] Hello, World!\r\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ticks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">delay_ms</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>在 Arch Linux 下，用 <code>minicom</code> 连上串口：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">minicom -D /dev/ttyUSB0</span><br></span></code></pre></div></div>
<p>可以看到串口输出类似这样：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[0]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[501]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1002]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1503]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2004]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2505]Hello, World!</span><br></span></code></pre></div></div>
<p>如果把时间戳改成浮点数，直接显示秒数：，而不是 <code>ticks</code>：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;[%f]Hello, World!\r\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">float</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ticks</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1000.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[]Hello, World!</span><br></span></code></pre></div></div>
<p>浮点数完全没有被打印出来。这并不是代码写错了，而是因为使用了 <code>--specs=nano.specs</code>，<strong>Newlib-nano 默认关闭了 <code>printf()</code> 的浮点支持</strong>。</p>
<p>解决方法也很简单，在 <code>Makefile</code> 里额外加上 <code>-u _printf_float</code>，显式启用浮点格式化支持。重新编译后，输出就恢复正常了：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[0.000000]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0.502000]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1.004000]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1.506000]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2.008000]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2.510000]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[3.012000]Hello, World!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[3.514000]Hello, World!</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="小结">小结<a href="#小结" class="hash-link" aria-label="Direct link to 小结" title="Direct link to 小结" translate="no">​</a></h3>
<p>到这里，一个<strong>真正能用 <code>printf()</code> 的裸机工程</strong>就算完整跑通了，现在有标准库、有串口输出，也具备了最基础的调试手段。如果想继续折腾，可以试着实现 <code>_read()</code>，直接用 <code>scanf()</code> 从串口读输入。</p>
<p>下一步，我们将讨论如何把构建系统升级到 <strong>CMake</strong>，顺便引入 STM 官方库，让外设配置不再完全依赖翻参考手册。</p>
<h2 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="第-4-部分裸机编程之-cmake-构建系统和-stm32-库">第 4 部分：裸机编程之 CMake 构建系统和 STM32 库<a href="#第-4-部分裸机编程之-cmake-构建系统和-stm32-库" class="hash-link" aria-label="Direct link to 第 4 部分：裸机编程之 CMake 构建系统和 STM32 库" title="Direct link to 第 4 部分：裸机编程之 CMake 构建系统和 STM32 库" translate="no">​</a></h2>
<p>上一节中，引入了精简版 C 标准库（<code>newlib-nano</code>），并成功让 <code>printf()</code> 通过 UART 输出字符。到这里，项目已经具备了最基础的调试能力。</p>
<p>不过目前的构建方式仍然停留在 <strong>手写 Makefile + 直接操作寄存器</strong> 的阶段。这种方式完全没问题，甚至在小项目里非常清晰直观。但随着代码量增加，编译选项、源文件、第三方库逐渐变多，Makefile 很容易变得臃肿难维护。</p>
<p>这一部分的目标有两个：</p>
<ol>
<li class="">用 <strong>CMake</strong> 重构构建系统，让配置更清晰、也更容易扩展</li>
<li class="">引入 <strong>STM32 官方库（CMSIS / HAL）</strong>，减少重复的寄存器配置工作</li>
</ol>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="cmake-是什么">CMake 是什么？<a href="#cmake-是什么" class="hash-link" aria-label="Direct link to CMake 是什么？" title="Direct link to CMake 是什么？" translate="no">​</a></h3>
<p>CMake（<em>cross-platform make</em>）并不是一个真正“负责编译”的工具，而是一个<strong>构建系统生成器</strong>。它的作用是：
用一套平台无关的配置，生成适合当前系统的构建文件。</p>
<p>常见的组合是：</p>
<ul>
<li class="">Linux → 生成 GNU Makefile</li>
<li class="">Windows → 生成 Ninja / Visual Studio 工程</li>
<li class="">macOS → 生成 Xcode 工程</li>
</ul>
<p>核心配置都写在 <code>CMakeLists.txt</code> 里，CMake 负责把这些配置翻译成具体构建工具能理解的形式。</p>
<p>整个流程大致是这样：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/sites/assets/images/CMake_config_build-1-642x1024-c10d25f80aedf0f716a95ff869747460.png" width="642" height="1024" class="img_ev3q"></p>
<p>这种方式最大的好处是，<strong>同一份工程配置，可以在不同平台上复用</strong>。再配合 toolchain file，还能很方便地切换交叉编译目标。</p>
<p>随着项目规模的扩大，单纯依赖 Makefile 往往会导致构建逻辑变得臃肿且难以维护。编译选项、链接参数以及各模块的源文件列表通常交织在一个庞大的文件中，缺乏层次感。</p>
<p>CMake 的思路正好相反：<strong>按模块拆分构建逻辑</strong>。</p>
<p>在典型的工程实践中，源代码通常按功能解耦，例如硬件驱动（Drivers）、通用模块（Common）、第三方库（Third Party）以及应用层代码（Application）。</p>
<p>与其在单个 <code>CMakeLists.txt</code> 中硬编码整个构建过程，不如在每个子目录下分别建立逻辑。这种方式下，每个功能块都被抽象为一个<strong>目标（Target）</strong>，通常是静态库（Static Library）。根目录下的 <code>CMakeLists.txt</code> 则充当“指挥官”，负责将这些离散的模块整合在一起。</p>
<p>典型的项目结构如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">project_root/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── CMakeLists.txt           # 项目根配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cmake/                   # 存放交叉编译工具链定义及特定芯片配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── stm32f103.cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── cmsis.cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── third_party/             # 第三方组件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── CMSIS/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── drivers/                 # 硬件抽象层/底层驱动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── CMakeLists.txt       # 将 gpio.c, i2c.c 等编译为驱动库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── gpio.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── i2c.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── common/                  # 通用工具类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── CMakeLists.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── utils.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── dsp.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── application/             # 业务逻辑与应用代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── CMakeLists.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── main.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── blink_task.c</span><br></span></code></pre></div></div>
<p>驱动层、通用模块以及应用层都会各自编译成独立的静态库。遇到那些<strong>并没有原生支持 CMake 的第三方库</strong>，也不需要动它们的源码，只要在项目里单独写一个对应的 <code>.cmake</code> 文件负责构建即可，避免在库目录里硬塞 <code>CMakeLists.txt</code>，把源码弄得一团糟。在项目根目录的 <code>CMakeLists.txt</code> 中，只需要把这些静态库统一链接起来，生成最终的可执行文件，整体结构就会非常清晰，也更容易保持模块之间的边界。</p>
<p>把原来“单文件 Makefile”的构建方式迁移到 CMake，不仅是为了“更现代”的构建体验，更是为了应对未来引入更多外设驱动（如 I2C、SPI）或中间件时的复杂度。接下来，我们将逐步实现这一迁移：定义交叉编译工具链，以及为每个模块编写对应的 <code>CMakeLists.txt</code>，最后构建出我们最终的 <code>.elf</code> 和 <code>.bin</code> 镜像。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="从-gnu-make-迁移到-cmake">从 GNU Make 迁移到 CMake<a href="#从-gnu-make-迁移到-cmake" class="hash-link" aria-label="Direct link to 从 GNU Make 迁移到 CMake" title="Direct link to 从 GNU Make 迁移到 CMake" translate="no">​</a></h3>
<p>在第 2 部分里，已经写过一个 <code>Makefile</code>：里面指定了使用的编译器，定义了一系列编译和链接选项，同时还包含两个目标——一个是主程序（<code>main</code>），另一个是用于把程序刷写到开发板上的伪目标（phony target）。</p>
<p>现在要在 CMake 中复刻这套流程，但思路会稍微不一样。这里不会把所有配置都堆在一个 <code>CMakeLists.txt</code> 里，而是单独引入一个<strong>工具链文件（Toolchain File）</strong>，把所有与硬件和平台相关的配置从主构建脚本中剥离出来。</p>
<p>在 CMake 的配置阶段，可以通过指定这个 toolchain file 来明确当前要构建的目标平台；反过来，如果想编译一个能在本机直接运行的程序（比如做单元测试），也可以完全不使用 toolchain file。</p>
<p>这样做还有一个好处：将来如果更换到另一颗 MCU，只需要新写一个对应的 toolchain file，主 <code>CMakeLists.txt</code> 基本不用动。同一颗 MCU 的 toolchain file 甚至可以在多个项目之间复用，整体结构会非常干净。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="cmakeliststxt"><code>CMakeLists.txt</code><a href="#cmakeliststxt" class="hash-link" aria-label="Direct link to cmakeliststxt" title="Direct link to cmakeliststxt" translate="no">​</a></h3>
<p>下面开始动手写 <code>CMakeLists.txt</code>。对于一个<strong>最小可用示例</strong>来说，需要做的事情其实不多：指定 CMake 的最低版本、项目名称，以及至少一个构建目标（注意，这里的“目标”是构建目标，不是 MCU 目标设备）。</p>
<div class="language-cmake codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">CMakeLists.txt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cmake codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cmake_minimum_required(VERSION 3.15)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project(stm32-without-cubeide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LANGUAGES C)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_executable(blink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startup.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syscalls.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    usart.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vendor/CMSIS/Device/ST/STM32F1/Source/Templates/system_stm32f1xx.c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set_target_properties(blink PROPERTIES OUTPUT_NAME &quot;blink.elf&quot;)</span><br></span></code></pre></div></div>
<p>这里选择了 CMake <strong>3.15</strong>，在兼容性和功能之间算是一个比较好的平衡点，对当前这个项目完全够用。项目名定为 <code>stm32-without-cubeide</code>，同时明确告诉 CMake：这是一个 <strong>C 语言</strong> 项目。接着定义了一个可执行目标 <code>blink</code>，并列出构建它所需的所有源文件。不需要像 Makefile 那样为每个 <code>.c</code> 文件单独写规则，CMake 会自动处理依赖关系和增量构建。默认情况下，可执行文件名和目标名一致（这里是 <code>blink</code>，而且没有扩展名）。为了更贴近嵌入式开发的习惯，这里显式把输出文件名设为 <code>blink.elf</code>。</p>
<p>接下来，就可以开始添加一些<strong>项目相关的编译器和链接器选项</strong>了。</p>
<div class="language-cmake codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">CMakeLists.txt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cmake codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">target_compile_options(blink PRIVATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --specs=nano.specs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_include_directories(blink PRIVATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vendor/CMSIS/Device/ST/STM32F1/Include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	vendor/CMSIS/CMSIS/Core/Include)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_link_options(blink PRIVATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -T ${CMAKE_SOURCE_DIR}/linker_script.ld </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -u _printf_float)</span><br></span></code></pre></div></div>
<p>注意，这些编译和链接标志是<strong>显式添加到 <code>blink</code> 这个目标上的</strong>，而不是作为全局选项。这种做法的好处是显而易见的：这种做法的优势在于：可以在同一个项目中通过不同的构建配置定义多个目标，且各目标之间互不干扰。</p>
<p>这里使用了 <code>PRIVATE</code> 关键字来指定作用域，表示这些选项<strong>只对 <code>blink</code> 目标本身生效</strong>，不会传播给任何链接到该目标的其他目标。对于当前工程而言，由于并不打算让其他程序链接最终生成的执行文件，因此选择 <code>PRIVATE</code> 与否影响并不大。</p>
<p>但在更复杂的工程中，这个区分就非常重要了。如果构建的是一个库，并且希望下游目标在链接该库时自动继承这些编译选项，那么就应该使用 <code>PUBLIC</code> 或 <code>INTERFACE</code> 作用域：</p>
<ul>
<li class=""><strong><code>PUBLIC</code></strong>：选项既用于构建该库本身，也会传递给所有链接到该库的目标；</li>
<li class=""><strong><code>INTERFACE</code></strong>：选项只会作用于链接该库的目标，不会用于构建库自身。</li>
</ul>
<p>在开始编写 toolchain file 之前，再补充一个伪目标。在 CMake 中，这类目标被称为<strong>自定义目标（custom target）</strong>。</p>
<p>具体步骤是先定义若干变量，用于指定可执行文件路径以及刷写时需要的参数，然后创建一个自定义目标，将 <code>blink</code> 目标生成的 ELF 文件烧录到设备中。同时，让这个自定义目标依赖于 <code>blink</code>，这样一来，只要源代码发生变化，在执行刷写命令前就会自动触发重新构建，整个流程会更加顺畅。</p>
<div class="language-cmake codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">CMakeLists.txt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cmake codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set(PROGRAMMER openocd)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(PROGRAMMER_FLAGS -f interface/stlink.cfg -f target/stm32f1x.cfg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_custom_target(flash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    COMMAND ${PROGRAMMER} ${PROGRAMMER_FLAGS} -c &quot;program $&lt;TARGET_FILE:blink&gt; verify reset exit&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DEPENDS blink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    VERBATIM)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="工具链文件toolchain-file">工具链文件（Toolchain file）<a href="#工具链文件toolchain-file" class="hash-link" aria-label="Direct link to 工具链文件（Toolchain file）" title="Direct link to 工具链文件（Toolchain file）" translate="no">​</a></h3>
<p>工具链文件（toolchain file）用于描述<strong>为目标设备进行交叉编译所需的全部环境信息</strong>。这类文件的设计目标就是可复用——只要使用的是同一类 MCU，就可以在不同项目之间共享同一个工具链文件。因此，一个重要原则是：<strong>不要在工具链文件中加入任何项目特定的配置</strong>。</p>
<p>下面是我使用的工具链文件示例：</p>
<div class="language-cmake codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">CMakeLists.txt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cmake codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_SYSTEM_NAME Generic)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_TRY_COMPILE_TARGET_TYPE STATIC_LIBRARY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_C_COMPILER arm-none-eabi-gcc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_CXX_COMPILER arm-none-eabi-g++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_ASM_COMPILER arm-none-eabi-gcc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(MCU_FLAGS &quot;-mcpu=cortex-m3 -mthumb&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_C_FLAGS_INIT ${MCU_FLAGS})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_CXX_FLAGS_INIT ${MCU_FLAGS})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_ASM_FLAGS_INIT ${MCU_FLAGS})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_compile_definitions(STM32F102xB)</span><br></span></code></pre></div></div>
<p>首先，将 <code>CMAKE_SYSTEM_NAME</code> 设为 <code>Generic</code>，用来明确告诉 CMake：当前是在进行交叉编译，而不是为宿主系统构建程序。接着，通过设置 <code>CMAKE_TRY_COMPILE_TARGET_TYPE</code> 为 <code>STATIC_LIBRARY</code>，可以避免 CMake 在配置阶段尝试运行测试程序。默认情况下，CMake 会编译并执行一个小程序来验证编译器是否可用。但在交叉编译场景下，目标设备与宿主系统的 ABI 并不兼容，这个测试程序几乎不可能在本机运行，因此必须显式禁止这种行为。</p>
<p>随后，分别指定了 C、C++ 以及汇编代码使用的编译器。和之前的 <code>Makefile</code> 一样，这里通过 <code>-mcpu=cortex-m3</code> 和 <code>-mthumb</code> 告诉编译器目标处理器的类型和指令集架构。由于这些选项对项目中的所有目标都是一致的，它们被作为三个编译器的<strong>初始编译标志</strong>统一设置，在各个目标追加自身选项之前就已经生效。</p>
<p>如果需要更细粒度的控制，比如启用硬件浮点单元（FPU），也可以在这里扩展相关选项。不过默认情况下，FPU 支持是关闭的——毕竟并不是所有 MCU 都带有 FPU。所有与 ARM 相关的编译选项，都可以在 <a href="https://gcc.gnu.org/onlinedocs/gcc-15.2.0/gcc/ARM-Options.html" target="_blank" rel="noopener noreferrer" class="">GCC 官方文档</a> 中查到，其中一部分选项会随着 <code>-mcpu</code> 的指定而被隐式启用。</p>
<p>到这里，就可以尝试用 CMake 生成构建系统了。确保当前位于项目根目录（<code>CMakeLists.txt</code> 和 <code>stm32f103xb.cmake</code> 都在这里），然后在配置阶段通过 <code>CMAKE_TOOLCHAIN_FILE</code> 指定工具链文件：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cmake -Bbuild -DCMAKE_TOOLCHAIN_FILE=stm32f103xb.cmake</span><br></span></code></pre></div></div>
<p>这条命令会创建一个 build 子目录，并使用系统的默认生成器（generator）生成构建文件。可以通过 cmake --help 查看当前系统支持的生成器列表，其中带星号 <code>*</code> 的是默认值。在我的环境中，默认生成器是 Unix Makefiles，也就是说 CMake 会生成一套供 GNU Make 使用的 Makefile。如果需要，也可以通过 -G 选项显式指定生成器。</p>
<p>生成完成后，虽然可以像之前一样进入 build 目录直接运行 make，但更推荐的做法是使用 CMake 提供的统一构建接口：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cmake --build build</span><br></span></code></pre></div></div>
<p>这种方式与底层使用的构建系统无关，不论是 Make、Ninja 还是其他生成器，命令形式都保持一致。如果只想构建某个特定目标，比如刷写程序，可以使用 <code>--target</code>：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cmake --build build --target flash</span><br></span></code></pre></div></div>
<p>这样一来，整个构建和刷写流程就完全交给 CMake 统一管理了。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="关于-float-point-unitfpu">关于 Float Point Unit（FPU）<a href="#关于-float-point-unitfpu" class="hash-link" aria-label="Direct link to 关于 Float Point Unit（FPU）" title="Direct link to 关于 Float Point Unit（FPU）" translate="no">​</a></h3>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>Cortex-M3 本身并不带 FPU，所以这里就不展开了。原文中使用的是带有 FPU 的 <strong>STM32F410RB</strong>，因此专门讨论了这一部分。如果你使用的是支持硬件浮点的 MCU，可以直接参考原文对应章节：<a href="https://kleinembedded.com/stm32-without-cubeide-part-4-cmake-fpu-and-stm32-libraries/" target="_blank" rel="noopener noreferrer" class="">https://kleinembedded.com/stm32-without-cubeide-part-4-cmake-fpu-and-stm32-libraries/</a></p></div></div>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="引入-stm32cubef1-官方库">引入 STM32CubeF1 官方库<a href="#引入-stm32cubef1-官方库" class="hash-link" aria-label="Direct link to 引入 STM32CubeF1 官方库" title="Direct link to 引入 STM32CubeF1 官方库" translate="no">​</a></h3>
<p>STM32CubeF1 MCU Firmware Package 是 <a href="https://www.st.com/en/embedded-software/stm32cube-mcu-mpu-packages.html" target="_blank" rel="noopener noreferrer" class="">STM32Cube MCU and MPU package</a> 家族中的一员，由 STMicroelectronics 为旗下各条 MCU / MPU 产品线统一维护的一套代码库，目的是简化硬件配置和使用。它属于 STM32Cube 生态的一部分，但并不强制依赖 <strong>STM32CubeMX</strong>、<strong>STM32CubeIDE</strong> 或其他 STM 官方工具，完全可以拿出来单独用。这一点对不想被 IDE 绑定的裸机工程来说非常友好。</p>
<p>个包的组成大致包括：</p>
<ul>
<li class=""><strong>CMSIS</strong>（前面已经用过）</li>
<li class=""><strong>Low Layer（LL）</strong></li>
<li class=""><strong>Hardware Abstraction Layer（HAL）</strong></li>
<li class="">各种中间件（middleware），比如 <strong>FreeRTOS</strong>、<strong>mbedTLS</strong></li>
<li class="">以及一大堆示例工程</li>
</ul>
<p>所有内容都可以直接从 ST 官方的 GitHub 仓库获取：<a href="https://github.com/STMicroelectronics/STM32CubeF1" target="_blank" rel="noopener noreferrer" class="">https://github.com/STMicroelectronics/STM32CubeF1</a></p>
<p>如果目标是“尽量精简”，完全可以直接下载 zip 包，只保留自己真正需要的部分，其余的统统删掉。举个例子，如果更偏向底层寄存器操作、对 HAL 没什么兴趣，那么只留下设备相关的 <strong>CMSIS</strong> 文件和 <strong>LL</strong> 库就足够了。</p>
<p>这里出于教学和可维护性的考虑，选择把官方仓库作为 <strong>git 子模块（submodule）</strong> 引入项目，然后再从中挑选需要的子目录使用。这样一来，后续如果官方有更新或修复 bug，也可以比较轻松地同步进来。</p>
<h4 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="添加子模块">添加子模块<a href="#添加子模块" class="hash-link" aria-label="Direct link to 添加子模块" title="Direct link to 添加子模块" translate="no">​</a></h4>
<p>要把一个 Git 仓库引入为现有项目的子模块，可以使用 <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules" target="_blank" rel="noopener noreferrer" class=""><code>git submodule</code></a>。这里打算把 STM32CubeF1 放到 <code>vendor</code> 目录下，在项目根目录执行：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git submodule add https://github.com/STMicroelectronics/STM32CubeF1 vendor/STM32CubeF1</span><br></span></code></pre></div></div>
<p>接着进入子模块目录，并初始化它：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd vendor/STM32CubeF1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git submodule update --init</span><br></span></code></pre></div></div>
<p>STM32CubeF1 仓库本身还包含不少嵌套子模块，分别对应不同 MCU 系列、评估板以及中间件。可以先用下面的命令看一眼都有哪些：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git submodule status</span><br></span></code></pre></div></div>
<p>里面会看到各种板级支持包（Board Support Package，BSP）、中间件，以及我们真正关心的 <strong>CMSIS</strong> 和 <strong>HAL</strong>。其他内容暂时用不上，所以这里只初始化这两个就够了。</p>
<p>确保当前位于 <code>vendor/STM32CubeF1</code> 目录下，然后执行：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git submodule update --init \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Drivers/CMSIS/Device/ST/STM32F1xx \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Drivers/STM32F1xx_HAL_Driver</span><br></span></code></pre></div></div>
<p>到这里，构建 HAL 所需的源文件已经齐全了。不过在真正把它们编进工程之前，还需要做一些必要的预配置。</p>
<h4 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="初始化-hal-设置">初始化 HAL 设置<a href="#初始化-hal-设置" class="hash-link" aria-label="Direct link to 初始化 HAL 设置" title="Direct link to 初始化 HAL 设置" translate="no">​</a></h4>
<p>如果打开 <a href="https://www.st.com/resource/en/user_manual/um1850-description-of-stm32f1-hal-and-lowlayer-drivers-stmicroelectronics.pdf" target="_blank" rel="noopener noreferrer" class="">STM32F1 HAL user maunal</a>(UM1850)，翻到第 3 章 <em>Overview of HAL drivers</em>，其中 <strong>3.1.2 User-application files</strong> 的表 3 列出了构建一个 HAL 应用所需的最小文件集合。通过这张表，可以快速了解 HAL 库的整体组织方式：哪些文件由 HAL 提供，哪些必须由用户在应用层实现，以及这些文件各自承担的角色。</p>
<p><img decoding="async" loading="lazy" alt="HAL user-application files" src="/sites/assets/images/HAL-user_app-files-0a5dce90a7a39ec5feee1253b6597ef9.png" width="2206" height="1598" class="img_ev3q"></p>
<p>按照该表的说明，一个最小的 HAL 应用通常需要在用户工程中包含以下文件：</p>
<ul>
<li class=""><code>system_stm32f1xx.c</code>：系统初始化相关代码（时钟、缓存等核心功能）</li>
<li class=""><code>startup_stm32f1xx.s</code>：启动代码以及以弱符号形式声明的中断向量和 ISR</li>
<li class=""><code>stm32f1xx_hal_msp.c</code>：MCU Support Package，用户实现的底层硬件初始化</li>
<li class=""><code>stm32f1xx_hal_conf.h</code>：HAL 功能裁剪与配置头文件</li>
<li class=""><code>stm32f1xx_it.c / .h</code>：用户实现的中断服务程序</li>
<li class=""><code>main.c / .h</code>：应用入口及全局定义</li>
</ul>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>如果你使用的是官方开发板（例如 <code>STM32F103RB-Nucleo</code>），上述文件可以直接在
<code>vendor/STM32CubeF1/Projects/STM32F103RB-Nucleo/Templates</code>
目录中找到作为模板。我的开发板不在这些官方板卡之列，因此这里使用的是 <strong>STM32CubeMX 生成的工程文件</strong> 作为起点。</p></div></div>
<p>由于这里采用了 ST 官方提供的启动文件，因此也需要配套使用其链接脚本 <code>STM32F103XX_FLASH.ld</code>（同样可以在 Templates 目录中找到，或者由 CubeMX 生成）。这是因为启动代码中会用到链接脚本里定义的一些符号（例如 <code>_estack</code>），而中断向量表中引用的函数（如 <code>Reset_Handler</code>）也都在启动文件中声明。虽然这些内容完全可以手动对齐，但直接使用 ST 提供的成套文件可以显著降低出错概率。</p>
<p>接下来，在项目根目录下创建一个 <code>core</code> 子目录，并将上述模板文件全部复制进去。这样一来，就可以放心地修改这些文件，而不用担心将来更新 STM32CubeF1 子模块时被覆盖。另外，还需要在项目根目录创建一个 <code>main.h</code> 头文件，用于放置全局定义和句柄（handle）。这些内容不仅会被 <code>main.c</code> 使用，也会被诸如 <code>stm32f1xx_it.c</code> 这样的文件引用。</p>
<p>至此，HAL 所需的源文件已经准备就绪。下一步，我们将使用 CMake 将这些文件组织成可复用的库，并把它们集成进现有的裸机工程中。</p>
<h4 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="构建-hal-库">构建 HAL 库<a href="#构建-hal-库" class="hash-link" aria-label="Direct link to 构建 HAL 库" title="Direct link to 构建 HAL 库" translate="no">​</a></h4>
<p>STM32CubeF1 包本身并不包含 <code>CMakeLists.txt</code>，因此需要自己补上这一层。但显然不希望直接在子模块（submodule）目录里动刀子，免得“污染”上游仓库，也给后续更新添麻烦。一个更干净的做法是在项目根目录下新建一个 <code>cmake</code> 目录（前面放 toolchain file 的地方），然后在这里新增一个 <code>stm32cubef1.cmake</code> 文件。最后，只需要在主 <code>CMakeLists.txt</code> 中 <code>include()</code> 它即可。</p>
<p>在 <code>stm32cubef1.cmake</code> 里，主要做三件事：</p>
<ol>
<li class="">定义一些变量，用来描述 CMSIS / HAL 的路径结构；</li>
<li class="">指定需要参与构建的 HAL 源文件；</li>
<li class="">通过 <code>add_library()</code> 把这些源文件编译成一个静态库。</li>
</ol>
<p>同时，使用 <code>PUBLIC</code> 作用域添加包含目录，这样任何链接到该库的目标（比如 <code>blink</code>）都会自动继承这些头文件路径。</p>
<div class="language-cmake codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">stm32cubef1.cmake</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cmake codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set(STM32CUBEF1_DIR &quot;${CMAKE_SOURCE_DIR}/vendor/STM32CubeF1&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(HAL_ROOT_DIR &quot;${STM32CUBEF1_DIR}/Drivers/STM32F1xx_HAL_Driver&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(HAL_SOURCE_DIR &quot;${HAL_ROOT_DIR}/Src&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(HAL_INCLUDE_DIR &quot;${HAL_ROOT_DIR}/Inc&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(HAL_SOURCES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;${HAL_SOURCE_DIR}/stm32f1xx_hal.c&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;${HAL_SOURCE_DIR}/stm32f1xx_hal_rcc.c&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;${HAL_SOURCE_DIR}/stm32f1xx_hal_cortex.c&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;${HAL_SOURCE_DIR}/stm32f1xx_hal_gpio.c&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;${HAL_SOURCE_DIR}/stm32f1xx_hal_uart.c&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;${HAL_SOURCE_DIR}/stm32f1xx_hal_dma.c&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_library(stm32cubef1 STATIC ${HAL_SOURCES})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_include_directories(stm32cubef1 PUBLIC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ${STM32CUBEF1_DIR}/Drivers/CMSIS/Core/Include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ${STM32CUBEF1_DIR}/Drivers/CMSIS/Device/ST/STM32F1xx/Include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ${STM32CUBEF1_DIR}/Drivers/STM32F1xx_HAL_Driver/Inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ${CMAKE_SOURCE_DIR}/core)</span><br></span></code></pre></div></div>
<p>接下来，在项目根目录的 <code>CMakeLists.txt</code> 中（放在 <code>add_executable()</code> 之后），通过 <code>include()</code> 引入这个文件。这样 <code>stm32cubef1</code> 库就会先被构建，然后再链接到 <code>blink</code> 目标中：</p>
<div class="language-cmake codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">CMakeLists.txt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cmake codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">include(cmake/stm32cubef1.cmake)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_link_libraries(blink stm32cubef1)   </span><br></span></code></pre></div></div>
<p>在 CMSIS 的 STM32F1 设备头文件 <code>stm32f1xx.h</code> 中，ST 还写了这样一段条件包含：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">defined</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">USE_HAL_DRIVER</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;stm32f1xx_hal.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* USE_HAL_DRIVER */</span><br></span></code></pre></div></div>
<p>也就是说，只要给编译器加上 <code>USE_HAL_DRIVER</code> 这个宏，在包含 <code>stm32f1xx.h</code> 时就会自动把 <code>stm32f1xx_hal.h</code> 一并拉进来。这个宏几乎只用于这个目的，因此完全可以选择不定义它、手动 <code>#include &quot;stm32f1xx_hal.h&quot;</code>，效果是一样的。这里为了演示 HAL 的“标准用法”，在项目根目录的 <code>CMakeLists.txt</code> 顶部（<code>project()</code> 之后、任何目标定义之前）添加这个宏定义：</p>
<div class="language-cmake codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">CMakeLists.txt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cmake codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">add_compile_definitions(USE_HAL_DRIVER)</span><br></span></code></pre></div></div>
<p>由于现在换用了新的启动文件，并且引入了 <code>core</code> 目录下的一系列源文件，需要同步更新 <code>blink</code> 目标的源文件列表。这里先定义一个 <code>BLINK_SOURCES</code> 变量，再传给 <code>add_executable()</code>，可读性会好一些。与此同时，还需要：</p>
<ul>
<li class="">把项目根目录和 <code>core</code> 目录加入 <code>blink</code> 的包含路径；</li>
<li class="">更新链接脚本路径；</li>
<li class="">顺手开启 <code>printf</code> 的浮点支持。</li>
</ul>
<div class="language-cmake codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">CMakeLists.txt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cmake codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set(BLINK_SOURCES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    core/syscalls.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    core/startup_stm32f103xb.s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    core/system_stm32f1xx.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    core/stm32f1xx_hal_msp.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    core/stm32f1xx_it.c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_executable(blink ${BLINK_SOURCES})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_include_directories(blink PRIVATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ${CMAKE_SOURCE_DIR}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ${CMAKE_SOURCE_DIR}/core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_link_options(blink PRIVATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -T ${CMAKE_SOURCE_DIR}/core/STM32F103XX_FLASH.ld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -u _printf_float)</span><br></span></code></pre></div></div>
<p>在构建之前，还有最后一步：让 CMake 知道这个工程里包含汇编代码（<code>core/startup_stm32f103xb.s</code>）。只需要在 <code>project()</code> 命令中，把 <code>ASM</code> 追加到 <code>LANGUAGES</code> 列表即可：</p>
<div class="language-cmake codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">CMakeLists.txt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cmake codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">project(stm32-without-cubeide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LANGUAGES C ASM)</span><br></span></code></pre></div></div>
<p>到这里，HAL 已经被完整地集成进工程中。现在可以像之前一样使用 CMake 构建项目，接下来就可以开始在代码里真正使用 HAL API 了。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="使用-hal-重写项目">使用 HAL 重写项目<a href="#使用-hal-重写项目" class="hash-link" aria-label="Direct link to 使用 HAL 重写项目" title="Direct link to 使用 HAL 重写项目" translate="no">​</a></h3>
<p>一旦熟悉了 HAL 库的使用方式，其实整体流程还是比较直观的，所以下面不会展开讲 HAL 的使用细节。如果想系统了解 HAL，强烈建议直接阅读用户手册 <a href="https://www.st.com/resource/en/user_manual/um1850-description-of-stm32f1-hal-and-lowlayer-drivers-stmicroelectronics.pdf" target="_blank" rel="noopener noreferrer" class="">UM1850</a>，其中第 3 章对 HAL 的整体设计思路讲得非常清楚，包括各类外设句柄（handle）对应的结构体、初始化方式，以及驱动的一般使用流程。等对整体框架有了感觉之后，再按需查阅具体外设章节，会更高效一些。</p>
<p>在应用代码的最开始，需要做的第一件事就是初始化 HAL：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">HAL_Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div>
<p><code>HAL_Init()</code> 会完成几件关键的事情，它会初始化 <code>SysTick</code> 定时器，并调用用户可自定义的 <code>HAL_MspInit()</code>。如果有系统级的硬件初始化需求（比如时钟、GPIO 或中断优先级的统一配置），可以在 <code>stm32f1xx_hal_msp.c</code> 中实现。</p>
<p>既然 HAL 已经接管了 <code>SysTick</code>，之前手写的那一套就可以删掉了，包括：</p>
<ul>
<li class=""><code>SysTick_Config</code></li>
<li class=""><code>__enable_irq()</code></li>
<li class=""><code>ticks</code> 变量</li>
<li class=""><code>systick_handler()</code> 和 <code>delay_ms()</code></li>
</ul>
<p>新的启动代码已经为 <code>SysTick</code> 中断提供了默认的处理函数 <code>SysTick_Handler()</code>，它位于 <code>stm32f1xx_it.c</code> 中：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">stm32f1xx_it.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SysTick_Handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">HAL_IncTick</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>同时，HAL 也提供了现成的延时函数 <code>HAL_Delay()</code>，可以直接替换主循环中原来的 <code>delay_ms()</code>。这样一来，主循环就会变得更干净一些：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_GPIO_TogglePin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_13</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;[%f]Hello, World!\r\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">float</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">uwTick</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1000.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_Delay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>到这里，<code>SysTick</code>、时间基准以及延时相关的逻辑就全部交给 HAL 处理了，应用层代码只需要关心“要做什么”，而不是“底层怎么实现”。这也是 HAL 最大的价值所在。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="时钟配置-1">时钟配置<a href="#时钟配置-1" class="hash-link" aria-label="Direct link to 时钟配置" title="Direct link to 时钟配置" translate="no">​</a></h3>
<p>根据用户手册 UM1850 第 3.11.1 节的说明，HAL 下的时钟系统配置主要通过两个函数完成：<code>HAL_RCC_OscConfig()</code> 和 <code>HAL_RCC_ClockConfig()</code>。它们都采用“初始化结构体 + 函数调用”的方式，而不是直接去操作寄存器位。</p>
<p>和前面第 2 部分一样，Flash 等待周期（Flash latency）依然需要正确配置。不同的是，这一次不再需要手动算位、查寄存器偏移，HAL 已经把这些细节封装成了比较友好的接口。</p>
<p>下面是新的时钟初始化代码：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RCC_OscInitTypeDef RCC_OscInitStruct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_ClkInitTypeDef RCC_ClkInitStruct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_OscInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OscillatorType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_OSCILLATORTYPE_HSE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_OscInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HSEState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_HSE_ON</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_OscInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HSEPredivValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_HSE_PREDIV_DIV1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_OscInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HSIState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_HSI_ON</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_OscInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PLL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PLLState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_PLL_ON</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_OscInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PLL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PLLSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_PLLSOURCE_HSE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_OscInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PLL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PLLMUL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_PLL_MUL9</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">HAL_RCC_OscConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">RCC_OscInitStruct</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> HAL_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/** Initializes the CPU, AHB and APB buses clocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_ClkInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClockType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_CLOCKTYPE_HCLK</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">RCC_CLOCKTYPE_SYSCLK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">RCC_CLOCKTYPE_PCLK1</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">RCC_CLOCKTYPE_PCLK2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_ClkInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SYSCLKSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_SYSCLKSOURCE_PLLCLK</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_ClkInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AHBCLKDivider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_SYSCLK_DIV1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_ClkInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">APB1CLKDivider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_HCLK_DIV2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCC_ClkInitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">APB2CLKDivider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RCC_HCLK_DIV1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">HAL_RCC_ClockConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">RCC_ClkInitStruct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FLASH_LATENCY_2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> HAL_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>这段代码做的事情，其实和裸写寄存器时一模一样：启用 HSE，配置 PLL，最后把系统时钟切换到 PLL 输出。只是所有步骤都被拆分成了清晰的字段，读起来会更接近“配置表”，而不是一堆位运算。</p>
<p>最后还有一个容易忽略的小步骤：在 <code>clock_init()</code> 之后，仍然需要调用 <code>SystemCoreClockUpdate()</code>，让 HAL 内部的 <code>SystemCoreClock</code> 变量与当前的时钟配置保持一致。否则，一些依赖系统时钟计算的功能（比如 <code>HAL_Delay()</code>）可能会出现不符合预期的行为。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="gpio-初始化">GPIO 初始化<a href="#gpio-初始化" class="hash-link" aria-label="Direct link to GPIO 初始化" title="Direct link to GPIO 初始化" translate="no">​</a></h3>
<p>要让 LED 亮起来，第一步还是老规矩：给对应的 GPIO 外设上电。这里使用的是 GPIOC，所以需要先启用 GPIOC 的时钟。接着创建一个 GPIO 初始化结构体，并把它交给 <code>HAL_GPIO_Init()</code> 即可。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">__HAL_RCC_GPIOC_CLK_ENABLE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GPIO_InitTypeDef gpio_init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpio_init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_PIN_13</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpio_init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_MODE_OUTPUT_OD</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpio_init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pull </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_NOPULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpio_init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_SPEED_LOW</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">HAL_GPIO_Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">gpio_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>和直接写寄存器相比，这种方式更像是在“描述”引脚要做什么：哪个引脚、什么模式、是否上下拉、速度是多少，一眼就能看明白。</p>
<p>初始化完成后，主循环里也可以顺手把之前的位操作替换成 HAL 提供的接口，用 <code>HAL_GPIO_TogglePin()</code> 来翻转 LED 引脚：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">HAL_GPIO_TogglePin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_13</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;[%f]Hello, World!\r\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">float</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">uwTick</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1000.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">HAL_Delay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>到这里，LED 闪烁的逻辑和之前完全一致，只是所有硬件相关的操作都换成了 HAL 风格的 API。对照着看，会更容易理解 HAL 到底帮忙做了哪些事情，也更方便后续把代码迁移到其他 STM32 型号上。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="uart-初始化">UART 初始化<a href="#uart-初始化" class="hash-link" aria-label="Direct link to UART 初始化" title="Direct link to UART 初始化" translate="no">​</a></h3>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>外设初始化流程</div><div class="admonitionContent_BuS1"><p>在用户手册 UM1850 的 3.12.1 HAL usage models 一节中的 Figure 7. HAL driver model 展示了 HAL 外设驱动的标准初始化流程：</p><p><img decoding="async" loading="lazy" alt="HAL driver model" src="/sites/assets/images/HAL-driver-model-0ac388a620baa562ee92a0f8dabd0898.png" width="1307" height="1487" class="img_ev3q"></p><p>整体流程可以概括为四步：</p><ol>
<li class=""><strong>声明外设句柄</strong>（<code>PPP_HandleTypeDef</code>）</li>
<li class=""><strong>填充句柄中的初始化参数</strong></li>
<li class=""><strong>将句柄传递给初始化函数</strong> <code>HAL_PPP_Init()</code></li>
<li class=""><code>HAL_PPP_Init()</code>
<ul>
<li class="">调用 <code>HAL_PPP_MspInit()</code> 完成底层硬件初始化（GPIO、RCC 等，可由用户覆写）</li>
<li class="">初始化外设寄存器本身</li>
</ul>
</li>
</ol><p>其中，<code>HAL_PPP_MspInit()</code> 是一个<strong>由用户实现的回调函数</strong>。它会在 <code>HAL_PPP_Init()</code> 内部被自动调用，专门用于完成与外设“周边硬件资源”相关的初始化工作。</p><p>以 <code>USART3</code> 为例，除了配置 USART 寄存器本身之外，还需要：</p><ul>
<li class="">打开 USART 外设时钟</li>
<li class="">打开对应 GPIO 端口时钟</li>
<li class="">配置 TX / RX 引脚的复用功能</li>
</ul><p>这些操作并不属于 USART 模块自身，因此非常适合放在 <code>HAL_UART_MspInit()</code> 中。当然，从机制上讲，也可以在调用 <code>HAL_UART_Init()</code> 之前手动完成这些配置，但遵循 HAL 的设计模型可以让代码结构更加清晰、解耦也更彻底。</p><p><img decoding="async" loading="lazy" alt="HAL MSP initialization process" src="/sites/assets/images/HAL-msp-init-a6fc69b48e0590cf16c77a5cf7d98a79.png" width="1612" height="241" class="img_ev3q"></p></div></div>
<p>由于 UART 可以映射到不同的 GPIO 引脚，因此需要在调用 <code>HAL_UART_Init()</code> 之前明确 TX / RX 使用哪组引脚。这正是 <code>HAL_UART_MspInit()</code> 存在的意义。</p>
<p>在 <code>stm32f1xx_hal_msp.c</code> 中实现该函数。当调用 <code>HAL_UART_Init()</code> 时，这个回调函数会被自动触发。USART 时钟和 GPIO 初始化也在这里完成：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">stm32f1xx_hal_msp.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HAL_UART_MspInit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UART_HandleTypeDef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">huart</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">huart</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">Instance </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> USART3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIO_InitTypeDef GPIO_InitStruct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">__HAL_RCC_USART3_CLK_ENABLE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**USART3 GPIO Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     PB10     ------&gt; USART3_TX</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    PB11     ------&gt; USART3_RX</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIO_InitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_PIN_10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIO_InitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_MODE_AF_PP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIO_InitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_SPEED_FREQ_HIGH</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_GPIO_Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">GPIO_InitStruct</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIO_InitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_PIN_11</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIO_InitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_MODE_INPUT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GPIO_InitStruct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pull </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GPIO_NOPULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_GPIO_Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">GPIO_InitStruct</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>如果后续需要“反初始化” UART，对应地还应实现 <code>HAL_UART_MspDeInit()</code>。</p>
<p>相比之前直接操作寄存器的实现方式，HAL 下的 UART 初始化代码要简洁得多。同时，也不再需要自定义的 <code>usart_write()</code> 函数，因此可以直接删除 <code>usart.c / usart.h</code> 这两个文件。HAL 使用 <code>UART_HandleTypeDef</code> 来表示一个 UART 外设实例。该结构体中既包含外设实例指针，也包含初始化参数和运行时状态信息。</p>
<p>这里在 <code>main.c</code> 中定义一个全局句柄，并在 <code>main.h</code> 中使用 <code>extern</code> 声明，方便其他文件访问：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.h</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> UART_HandleTypeDef uart3</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>在 <code>main()</code> 中填充初始化结构体，并调用 <code>HAL_UART_Init()</code>。波特率等参数由 HAL 自动换算并写入对应寄存器：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">main.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">UART_HandleTypeDef uart3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uart3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> USART3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uart3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BaudRate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">115200</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uart3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WordLength </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> UART_WORDLENGTH_8B</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uart3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StopBits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> UART_STOPBITS_1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uart3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Parity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> UART_PARITY_NONE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uart3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> UART_MODE_TX_RX</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uart3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HwFlowCtl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> UART_HWCONTROL_NONE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uart3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OverSampling </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> UART_OVERSAMPLING_16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">HAL_UART_Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">uart3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> HAL_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>由于现在使用的是 <code>HAL_UART_Transmit()</code>，需要在 <code>syscalls.c</code> 中更新 <code>_write()</code> 的实现，让标准输出重定向到 UART：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;main.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int _write(int file, char *ptr, int len) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (void) file;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HAL_UART_Transmit(&amp;uart2, ptr, len, HAL_MAX_DELAY); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>至此，UART 的 HAL 初始化已经完成。现在可以重新构建并烧录程序，验证以下两点是否正常：</p>
<ul>
<li class="">LED 是否按预期闪烁</li>
<li class="">串口终端是否能接收到 <code>printf()</code> 输出</li>
</ul>
<p>如果这两点都工作正常，说明 HAL 已经成功接管了 GPIO、SysTick 和 UART 外设，整个工程也顺利完成了从“裸寄存器”到 HAL 风格的过渡。</p>
<h3 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="小结-1">小结<a href="#小结-1" class="hash-link" aria-label="Direct link to 小结" title="Direct link to 小结" translate="no">​</a></h3>
<p>到这里，整个工程已经完整跑通，使用 <strong>CMake</strong> 搭起了一个相对干净、可维护的构建系统，并成功引入了 <strong>HAL / LL 库</strong>，让外设配置和使用都轻松了不少。</p>
<p>如果觉得 HAL 的封装层次偏厚、代码量有点“膨胀”，完全可以只使用 <strong>LL 库</strong>，在可控范围内换取更贴近底层的感觉。反过来，如果对外设初始化细节不太熟，也可以借助 <strong>STM32CubeMX</strong> 先生成一份工程作为参考，再逐步拆解、迁移到自己的 CMake 项目中。</p>
<p>不管采用哪种方式，希望这篇文章能让你对 <strong>如何在不依赖 CubeIDE 的情况下，使用 CMake 组织 STM32 工程，并合理地引入 HAL</strong> 有一个整体认识。</p>
<p>下一部分将进入调试阶段：
<strong>第 5 部分：使用 GNU Debugger（GDB）进行远程调试。</strong></p>
<h2 class="anchor anchorTargetHideOnScrollNavbar_vjPI" id="参考资料">参考资料<a href="#参考资料" class="hash-link" aria-label="Direct link to 参考资料" title="Direct link to 参考资料" translate="no">​</a></h2>
<ul>
<li class=""><a href="https://www.amazon.com/Bare-Metal-Embedded-Programming-high-performance-microcontrollers/dp/183546081X/ref=pd_sim_d_sccl_2_1/138-7367255-5244911?pd_rd_w=UZR82&amp;content-id=amzn1.sym.7c24b67e-6f48-4291-a1d6-24d3e6952d7a&amp;pf_rd_p=7c24b67e-6f48-4291-a1d6-24d3e6952d7a&amp;pf_rd_r=9DA7Z1A06BC4XYYT6P2Z&amp;pd_rd_wg=wXIeF&amp;pd_rd_r=e991f116-8465-4488-b42f-214a0f5022ca&amp;pd_rd_i=183546081X&amp;psc=1" target="_blank" rel="noopener noreferrer" class="">Bare-Metal Embedded C Programming: Develop high-performance embedded systems with C for Arm microcontrollers</a></li>
<li class=""><a href="https://interrupt.memfault.com/" target="_blank" rel="noopener noreferrer" class="">Interrupt by Memfault</a> @ <a href="https://interrupt.memfault.com/blog/boostrapping-libc-with-newlib" target="_blank" rel="noopener noreferrer" class="">From Zero to main(): Bootstrapping libc with Newlib</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/WheelsLab/site/tree/master/docs/development/embedded-mcu-dev/bare-metal-programming/bare-metal-programming-without-CubeIDE.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/sites/docs/development/embedded-mcu-dev/bare-metal-programming"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">裸机编程</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/sites/docs/development/embedded-mcu-dev/stm32-dev-basic"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">STM32 基础</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#第-1-部分裸机编程之最小闪灯程序" class="table-of-contents__link toc-highlight">第 1 部分：裸机编程之最小闪灯程序</a><ul><li><a href="#构建流程" class="table-of-contents__link toc-highlight">构建流程</a></li><li><a href="#链接脚本如何安排代码在内存中的位置" class="table-of-contents__link toc-highlight">链接脚本——如何安排代码在内存中的位置</a></li><li><a href="#启动代码在执行-main-之前做好准备" class="table-of-contents__link toc-highlight">启动代码——在执行 <code>main()</code> 之前做好准备</a></li><li><a href="#最小闪灯程序" class="table-of-contents__link toc-highlight">最小闪灯程序</a></li><li><a href="#构建可执行文件" class="table-of-contents__link toc-highlight">构建可执行文件</a></li><li><a href="#把程序加载到微控制器烧录" class="table-of-contents__link toc-highlight">把程序加载到微控制器（烧录）</a></li><li><a href="#下节预告" class="table-of-contents__link toc-highlight">下节预告</a></li></ul></li><li><a href="#第-2-部分裸机编程之-arm-官方库-cmsis" class="table-of-contents__link toc-highlight">第 2 部分：裸机编程之 ARM 官方库 CMSIS</a><ul><li><a href="#cmsis-和寄存器定义" class="table-of-contents__link toc-highlight">CMSIS 和寄存器定义</a></li><li><a href="#gnu-make-和-makefile" class="table-of-contents__link toc-highlight">GNU Make 和 Makefile</a></li><li><a href="#时钟配置" class="table-of-contents__link toc-highlight">时钟配置</a><ul><li><a href="#使用高速外部hse振荡器" class="table-of-contents__link toc-highlight">使用高速外部（HSE）振荡器</a></li><li><a href="#闪存延迟flash-wait-states" class="table-of-contents__link toc-highlight">闪存延迟（Flash Wait States）</a></li><li><a href="#利用锁相环pll提高时钟频率" class="table-of-contents__link toc-highlight">利用锁相环（PLL）提高时钟频率</a></li><li><a href="#使用-systick-验证时钟频率" class="table-of-contents__link toc-highlight">使用 SysTick 验证时钟频率</a></li></ul></li><li><a href="#下节预告-1" class="table-of-contents__link toc-highlight">下节预告</a></li></ul></li><li><a href="#第-3-部分裸机编程之-c--标准库和-printf" class="table-of-contents__link toc-highlight">第 3 部分：裸机编程之 C  标准库和 <code>printf()</code></a><ul><li><a href="#c-标准库" class="table-of-contents__link toc-highlight">C 标准库</a></li><li><a href="#添加-newlib-nano" class="table-of-contents__link toc-highlight">添加 Newlib-nano</a></li><li><a href="#系统调用" class="table-of-contents__link toc-highlight">系统调用</a></li><li><a href="#初始化库" class="table-of-contents__link toc-highlight">初始化库</a></li><li><a href="#修订链接脚本" class="table-of-contents__link toc-highlight">修订链接脚本</a></li><li><a href="#设置-uart" class="table-of-contents__link toc-highlight">设置 UART</a></li><li><a href="#将-printf-重定向到-uart" class="table-of-contents__link toc-highlight">将 <code>printf()</code> 重定向到 UART</a></li><li><a href="#小结" class="table-of-contents__link toc-highlight">小结</a></li></ul></li><li><a href="#第-4-部分裸机编程之-cmake-构建系统和-stm32-库" class="table-of-contents__link toc-highlight">第 4 部分：裸机编程之 CMake 构建系统和 STM32 库</a><ul><li><a href="#cmake-是什么" class="table-of-contents__link toc-highlight">CMake 是什么？</a></li><li><a href="#从-gnu-make-迁移到-cmake" class="table-of-contents__link toc-highlight">从 GNU Make 迁移到 CMake</a></li><li><a href="#cmakeliststxt" class="table-of-contents__link toc-highlight"><code>CMakeLists.txt</code></a></li><li><a href="#工具链文件toolchain-file" class="table-of-contents__link toc-highlight">工具链文件（Toolchain file）</a></li><li><a href="#关于-float-point-unitfpu" class="table-of-contents__link toc-highlight">关于 Float Point Unit（FPU）</a></li><li><a href="#引入-stm32cubef1-官方库" class="table-of-contents__link toc-highlight">引入 STM32CubeF1 官方库</a><ul><li><a href="#添加子模块" class="table-of-contents__link toc-highlight">添加子模块</a></li><li><a href="#初始化-hal-设置" class="table-of-contents__link toc-highlight">初始化 HAL 设置</a></li><li><a href="#构建-hal-库" class="table-of-contents__link toc-highlight">构建 HAL 库</a></li></ul></li><li><a href="#使用-hal-重写项目" class="table-of-contents__link toc-highlight">使用 HAL 重写项目</a></li><li><a href="#时钟配置-1" class="table-of-contents__link toc-highlight">时钟配置</a></li><li><a href="#gpio-初始化" class="table-of-contents__link toc-highlight">GPIO 初始化</a></li><li><a href="#uart-初始化" class="table-of-contents__link toc-highlight">UART 初始化</a></li><li><a href="#小结-1" class="table-of-contents__link toc-highlight">小结</a></li></ul></li><li><a href="#参考资料" class="table-of-contents__link toc-highlight">参考资料</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/sites/docs/cs-complete">CS 补完计划</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">社交网站</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">其他</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/sites/blog">博客</a></li><li class="footer__item"><a href="https://github.com/WheelsLab" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyleft © 2026 Wheels Lab. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>